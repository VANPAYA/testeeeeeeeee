<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½ â€” Kanji & Jogo</title>

<style>
:root{
  --bg:#0b0f14;
  --border:rgba(255,255,255,.16);
  --text:#eef2ff;
  --muted:rgba(238,242,255,.72);
  --muted2:rgba(238,242,255,.55);

  /* THEME (muda a cada 5s) */
  --themeHue: 195;

  /* Mood (sÃ³ indicador do jogo) */
  --moodHue: 195;

  --accent:  hsl(calc(var(--themeHue) - 25) 90% 60%);
  --accent2: hsl(var(--themeHue) 90% 58%);
  --accent3: hsl(calc(var(--themeHue) + 55) 90% 62%);

  --good:#34d399;
  --bad:#fb7185;
  --warn:#fbbf24;

  --radius:18px;
  --shadow: 0 18px 60px rgba(0,0,0,.55);

  --selectBg:#0f1826;
  --selectBorder:rgba(255,255,255,.28);

  --inputBg:#0f1826;
  --inputBorder:rgba(255,255,255,.28);

  --toastBg: rgba(10,14,20,.84);
  --toastBorder: rgba(255,255,255,.18);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  color:var(--text);
  font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",system-ui,sans-serif;
  line-height:1.9;
  background:
    radial-gradient(1100px 650px at 12% 10%, hsla(calc(var(--themeHue) - 25), 90%, 60%, .22), transparent 55%),
    radial-gradient(900px 600px at 92% 15%, hsla(var(--themeHue), 90%, 58%, .18), transparent 55%),
    radial-gradient(900px 650px at 20% 92%, hsla(calc(var(--themeHue) + 55), 90%, 62%, .14), transparent 55%),
    var(--bg);
  transition: background .65s ease, filter .65s ease;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(10,14,20,.78);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border);
}

.topbar{
  max-width:1180px;
  margin:auto;
  padding:18px 18px 12px;
  display:flex;
  gap:16px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}

.brand{ min-width:280px; }
.brand .t{ font-size:20px; font-weight:900; letter-spacing:1.2px; }
.brand .s{ margin-top:6px; color:var(--muted); font-size:13px; }
.brand .s b{ color:var(--text); }

nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

.container{ max-width:1180px; margin:auto; padding:34px 18px 90px; }

.section{ display:none; }
.section.active{ display:block; }

.grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; }
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

.panel{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:22px;
  padding:16px;
  box-shadow: var(--shadow);
}
.panel h2{ margin:0 0 8px; font-size:15px; letter-spacing:.6px; }

.hint{ color:var(--muted); font-size:13px; margin:0; }

.row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }

.card{
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  border-radius: var(--radius);
  padding:16px;
  margin-top:12px;
}

.jp{ font-size:22px; font-weight:900; color: var(--accent2); letter-spacing:.6px; }
.hira{ margin-top:6px; color:var(--muted); font-size:13px; }
.mean{ margin-top:8px; font-size:14px; font-weight:700; }

.badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  color:var(--muted);
  background: rgba(255,255,255,.06);
}
.badge.n5{ border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95); }
.badge.n4{ border-color: rgba(59,130,246,.45); color: rgba(147,197,253,.95); }
.badge.tag{ border-color: rgba(255,255,255,.22); color: var(--text); }

.tabbtn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.10);
  color: rgba(238,242,255,.92);
  padding:10px 14px;
  border-radius:999px;
  font-size:13px;
  user-select:none;
  box-shadow: var(--shadow);
  transition: transform .08s ease, background .18s ease, border-color .18s ease;
}
.tabbtn:hover{ background: rgba(255,255,255,.14); }
.tabbtn:active{ transform: translateY(1px); }
.tabbtn.active{
  border-color: hsla(var(--themeHue), 90%, 60%, .60);
  background: hsla(var(--themeHue), 90%, 55%, .22);
}

.btn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.28);
  background: rgba(255,255,255,.12);
  color: rgba(255,255,255,.98);
  padding:9px 12px;
  border-radius:14px;
  font-size:12px;
  font-weight:800;
  user-select:none;
  transition: transform .08s ease, background .18s ease, border-color .18s ease;
}
.btn:hover{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.38); }
.btn:active{ transform: translateY(1px); }
.btn.primary{
  border-color: hsla(var(--themeHue), 90%, 60%, .70);
  background: hsla(var(--themeHue), 90%, 55%, .26);
}
.btn.good{ border-color: rgba(52,211,153,.75); background: rgba(52,211,153,.20); }
.btn.danger{ border-color: rgba(251,113,133,.75); background: rgba(251,113,133,.18); }
.btn.warn{ border-color: rgba(251,191,36,.75); background: rgba(251,191,36,.18); }

select{
  padding:9px 11px;
  border-radius:12px;
  border:1px solid var(--selectBorder);
  background: var(--selectBg);
  color: rgba(255,255,255,.96);
  outline:none;
  font-weight:900;
}
input[type="text"]{
  padding:9px 11px;
  border-radius:12px;
  border:1px solid var(--inputBorder);
  background: var(--inputBg);
  color: rgba(255,255,255,.96);
  outline:none;
  font-weight:900;
  min-width: 240px;
}
input[type="text"]::placeholder{ color: rgba(238,242,255,.55); font-weight:700; }

.kanjigrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  gap:12px;
  margin-top:12px;
}

.kanjiitem{
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.20);
  border-radius: 16px;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition: transform .12s ease, border-color .18s ease, background .18s ease;
}
.kanjiitem:hover{
  transform: translateY(-1px);
  border-color: hsla(var(--themeHue), 90%, 60%, .55);
  background: rgba(255,255,255,.13);
}
.kanjiitem .k{ font-size:28px; font-weight:900; color: var(--accent2); }
.kanjiitem .lvl{ margin-top:6px; font-size:11px; color: var(--muted); }
.kanjiitem .lvl b{ color: var(--text); }

.strokeBox{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.16);
  border-radius:16px;
  overflow:hidden;
  background: rgba(255,255,255,.07);
}
.strokeHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.12);
}
.strokeHead .t{ font-size:13px; color: var(--muted); }
.strokeBody{ padding:12px; }
.strokeBody svg{ width:100%; height:auto; display:block; }
.strokeNote{ color: var(--muted2); font-size:12px; margin-top:8px; }

.bigKanji{
  font-size:86px;
  font-weight:900;
  letter-spacing:2px;
  text-align:center;
  color: var(--accent2);
  line-height:1.0;
  margin: 8px 0 6px;
}

hr.sep{ border:none; border-top:1px solid rgba(255,255,255,.10); margin:14px 0; }

.small{ color: var(--muted); font-size:13px; }
.small b{ color: var(--text); }

.footer{ text-align:center; padding:40px 0 0; color: var(--muted2); font-size:12px; }

.mcGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
@media (max-width: 820px){ .mcGrid{ grid-template-columns:1fr; } }

.mcBox{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.07);
}
.mcBox h3{ margin:0 0 8px; font-size:13px; color: var(--muted); letter-spacing:.6px; }

.choiceList{ display:grid; gap:8px; }
.choiceBtn{
  text-align:left;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.26);
  background: rgba(255,255,255,.14);
  color: rgba(255,255,255,.98);
  cursor:pointer;
  font-weight:900;
  transition: transform .08s ease, border-color .18s ease, background .18s ease;
}
.choiceBtn:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.18);
  border-color: hsla(var(--themeHue), 90%, 60%, .55);
}
.choiceBtn.correct{ border-color: rgba(52,211,153,.85); background: rgba(52,211,153,.22); }
.choiceBtn.wrong{ border-color: rgba(251,113,133,.85); background: rgba(251,113,133,.20); }
.choiceBtn:disabled{ opacity:.96; cursor:not-allowed; }

.timerBarWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.08);
  overflow:hidden;
  margin-top:10px;
}
.timerBar{
  height:100%;
  width:100%;
  background: linear-gradient(90deg,
    hsla(var(--themeHue), 90%, 60%, .90),
    hsla(calc(var(--themeHue) - 25), 90%, 60%, .85),
    hsla(calc(var(--themeHue) + 55), 90%, 62%, .75)
  );
  transition: width .12s linear, filter .65s ease;
}

.flash{ position: fixed; inset: 0; pointer-events: none; opacity: 0; z-index: 999; }
.flash.good{ background: radial-gradient(circle at 50% 35%, rgba(52,211,153,.24), transparent 62%); }
.flash.bad{  background: radial-gradient(circle at 50% 35%, rgba(251,113,133,.24), transparent 62%); }
.flash.warn{ background: radial-gradient(circle at 50% 35%, rgba(251,191,36,.18), transparent 62%); }
.flash.on{ animation: flash .55s ease-out; }
@keyframes flash{ 0%{ opacity:0; } 20%{ opacity:1; } 100%{ opacity:0; } }

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: rgba(238,242,255,.90);
  font-size:12px;
  font-weight:900;
  user-select:none;
}
.toggle input{
  width:16px;
  height:16px;
  accent-color: hsl(var(--themeHue) 90% 60%);
}

/* ===== VOCAB (3 exemplos) ===== */
.vocab3{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background: rgba(255,255,255,.06);
  padding:12px;
}
.vocab3 h4{
  margin:0 0 8px;
  font-size:13px;
  letter-spacing:.6px;
  color: var(--muted);
}
.vocabItem{
  padding:10px 10px;
  border-radius:14px;
  background: rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
  margin-top:8px;
}
.vocabTop{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
.vocabWord{ font-size:18px; font-weight:1000; color: rgba(255,255,255,.96); }
.vocabReading{ font-size:12px; color: var(--muted); font-weight:900; }
.vocabMeaning{ margin-top:6px; font-size:13px; color: rgba(238,242,255,.88); }

/* ===== TOAST ===== */
#toastWrap{
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 99999;
  display:grid;
  gap:10px;
  max-width: min(420px, calc(100vw - 28px));
}
.toast{
  background: var(--toastBg);
  border:1px solid var(--toastBorder);
  border-radius: 16px;
  padding: 10px 12px;
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  animation: toastIn .22s ease both;
}
@keyframes toastIn{ from{ opacity:0; transform: translateY(8px) scale(.98);} to{ opacity:1; transform: translateY(0) scale(1);} }
.toast .t{ font-weight:1000; font-size:12px; letter-spacing:.5px; }
.toast .m{ margin-top:4px; color: rgba(238,242,255,.84); font-size:12px; }
.toast.good{ border-color: rgba(52,211,153,.34); }
.toast.bad{ border-color: rgba(251,113,133,.34); }
.toast.warn{ border-color: rgba(251,191,36,.34); }

/* =========================================================
   PORTAL / ENTRADA â€” MAIS IMERSIVO (KANJI RAIN + FX)
========================================================= */
#app.appHidden{ display:none; }

.jpGate{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.jp-bg{
  position:absolute;
  inset:-40px;
  background:
    radial-gradient(1100px 700px at 18% 12%, rgba(130,90,255,.26), transparent 58%),
    radial-gradient(900px 650px at 84% 22%, rgba(0,255,200,.16), transparent 60%),
    radial-gradient(1000px 700px at 40% 88%, rgba(255,90,130,.16), transparent 58%),
    linear-gradient(180deg, rgba(8,10,14,.94), rgba(10,14,20,.98));
  transform: scale(1.05);
  filter: saturate(1.05);
}

.jp-vignette{
  position:absolute;
  inset:0;
  background:
    radial-gradient(900px 650px at 50% 45%, rgba(255,255,255,.06), transparent 58%),
    radial-gradient(900px 750px at 50% 50%, transparent 55%, rgba(0,0,0,.55) 78%),
    linear-gradient(180deg, rgba(0,0,0,.28), transparent 30%, rgba(0,0,0,.36));
  pointer-events:none;
  z-index:2;
  opacity:.9;
}
.jp-scan{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:2;
  opacity:.14;
  background:
    repeating-linear-gradient(180deg, rgba(255,255,255,.10) 0 1px, transparent 1px 4px);
  mix-blend-mode: overlay;
  animation: scan 9.5s linear infinite;
}
@keyframes scan{ 0%{ transform: translateY(-8%); } 100%{ transform: translateY(8%);} }

.jp-pattern{
  position:absolute;
  inset:0;
  opacity:.14;
  mix-blend-mode: screen;
  background:
    radial-gradient(circle at 0 0, rgba(255,255,255,.20) 0 2px, transparent 2px 18px) 0 0/38px 38px,
    radial-gradient(circle at 19px 19px, rgba(255,255,255,.14) 0 2px, transparent 2px 18px) 0 0/38px 38px,
    radial-gradient(circle at 0 0, rgba(120,90,255,.18) 0 1px, transparent 1px 22px) 0 0/44px 44px;
  filter: blur(.2px);
  z-index:1;
}

/* Kanji rain canvas */
#kanjiRain{
  position:absolute;
  inset:0;
  z-index:1;
  opacity:.42;
  mix-blend-mode: screen;
  filter: blur(.15px) saturate(1.05);
}

/* ===== ç„¡å¸¸ (MAIS VISÃVEL) ===== */
.mujo{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-52%);
  font-weight: 1000;
  letter-spacing: 12px;
  font-size: clamp(180px, 24vw, 360px);
  line-height: 1;
  opacity: .34;
  z-index: 2;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,.95),
    rgba(160,240,255,.70),
    rgba(210,170,255,.78),
    rgba(255,90,130,.55)
  );
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;

  -webkit-text-stroke: 1.2px rgba(255,255,255,.22);

  text-shadow:
    0 0 18px rgba(255,255,255,.10),
    0 0 48px rgba(160,240,255,.16),
    0 0 110px rgba(0,255,200,.10),
    0 0 160px rgba(255,90,130,.10);

  filter: drop-shadow(0 0 30px rgba(0,0,0,.60));
  animation: mujoBreath 6.8s ease-in-out infinite;
}
.mujo::before,
.mujo::after{
  content: "ç„¡å¸¸";
  position:absolute;
  inset:0;
  opacity:.55;
  pointer-events:none;
}
.mujo::before{
  transform: translate(2px, -1px);
  color: rgba(0,255,200,.18);
  filter: blur(.3px);
}
.mujo::after{
  transform: translate(-2px, 1px);
  color: rgba(255,90,130,.18);
  filter: blur(.3px);
}
@keyframes mujoBreath{
  0%,100%{ transform: translate(-50%,-52%) scale(1.00); opacity:.30; }
  50%{ transform: translate(-50%,-53%) scale(1.03); opacity:.40; }
}

/* ===== TORII ===== */
.jp-torii{
  position:absolute;
  left:50%;
  top:50%;
  width:min(1040px, 98vw);
  height:min(660px, 82vh);
  transform: translate(-50%,-54%);
  opacity:.78;
  pointer-events:none;
  z-index:3;
  animation: toriiFloat 5.6s ease-in-out infinite;
}
.jp-torii svg{
  width:100%;
  height:100%;
  display:block;
  filter: drop-shadow(0 0 34px rgba(0,0,0,.55));
}
@keyframes toriiFloat{
  0%,100%{ transform: translate(-50%,-54%) scale(1.01); opacity:.72; }
  50%{ transform: translate(-50%,-55.2%) scale(1.02); opacity:.84; }
}

.shoji{
  position:absolute;
  top:0; bottom:0;
  width:50%;
  background:
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 2px, transparent 2px 60px),
    repeating-linear-gradient(0deg, rgba(255,255,255,.08) 0 2px, transparent 2px 58px);
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 40px 140px rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity:.95;
  z-index:4;
}
.shoji.left{ left:0; border-right:1px solid rgba(255,255,255,.16); }
.shoji.right{ right:0; border-left:1px solid rgba(255,255,255,.16); }
.shoji::after{
  content:"";
  position:absolute;
  inset:0;
  background: radial-gradient(900px 700px at 60% 30%, rgba(120,90,255,.14), transparent 55%);
  opacity:.9;
}

.jp-card{
  position:relative;
  z-index:6;
  width:min(720px, 92vw);
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  box-shadow: 0 24px 90px rgba(0,0,0,.70);
  padding: 26px 22px;
  text-align:center;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  animation: jpIn 1.15s ease both;
}
@keyframes jpIn{
  from{ opacity:0; transform: translateY(18px) scale(.975); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

.jp-kicker{
  font-weight:1000;
  letter-spacing: 3px;
  font-size: 12px;
  color: rgba(238,242,255,.72);
  text-transform: uppercase;
}

.jp-title{
  margin-top: 8px;
  font-size: 34px;
  font-weight: 1000;
  letter-spacing: 2px;
  background: linear-gradient(90deg, rgba(255,255,255,.92), rgba(160,240,255,.88), rgba(210,170,255,.90));
  -webkit-background-clip:text;
  background-clip:text;
  color: transparent;
  text-shadow: 0 0 22px rgba(160,240,255,.18);
}

.jp-glow{
  display:inline-block;
  margin-left: 8px;
  color: rgba(255,255,255,.75);
  text-shadow: 0 0 20px rgba(0,255,200,.18);
  animation: star 1.6s ease-in-out infinite;
}
@keyframes star{
  0%,100%{ transform: translateY(0) rotate(0deg); opacity:.8; }
  50%{ transform: translateY(-3px) rotate(10deg); opacity:1; }
}

.jp-sub{
  margin-top: 10px;
  font-size: 15px;
  color: rgba(238,242,255,.82);
}
.jp-sub b{
  color: rgba(255,255,255,.96);
  text-shadow: 0 0 18px rgba(160,240,255,.20);
}

.jp-line{
  width: min(520px, 86%);
  height: 1px;
  margin: 18px auto 16px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
}

.jp-glitch{
  position:relative;
  display:inline-block;
  font-weight:1000;
}
.jp-glitch::before,
.jp-glitch::after{
  content: attr(data-text);
  position:absolute;
  left:0;
  top:0;
  opacity:.32;
  pointer-events:none;
}
.jp-glitch::before{
  transform: translate(1px,0);
  color: rgba(0,255,200,.55);
  animation: jpGlitch 1.9s infinite linear alternate-reverse;
}
.jp-glitch::after{
  transform: translate(-1px,0);
  color: rgba(255,90,130,.55);
  animation: jpGlitch 2.1s infinite linear alternate;
}
@keyframes jpGlitch{
  0%{ clip-path: inset(0 0 90% 0); }
  20%{ clip-path: inset(10% 0 55% 0); }
  40%{ clip-path: inset(35% 0 30% 0); }
  60%{ clip-path: inset(55% 0 15% 0); }
  80%{ clip-path: inset(75% 0 8% 0); }
  100%{ clip-path: inset(90% 0 0 0); }
}

.jp-btn{
  position:relative;
  border:none;
  cursor:pointer;
  padding: 14px 18px;
  border-radius: 18px;
  font-weight: 1000;
  letter-spacing: .6px;
  color: rgba(255,255,255,.96);
  background: linear-gradient(90deg, rgba(120,90,255,.56), rgba(0,255,200,.26), rgba(255,90,130,.34));
  box-shadow: 0 18px 55px rgba(0,0,0,.60);
  min-width: 180px;
}
.jp-btn:hover{ filter: brightness(1.12); }
.jp-btn:active{ transform: translateY(1px); }
.jp-btn:disabled{ opacity:.7; cursor:not-allowed; }
.jp-btn-main{ display:block; font-size:16px; }
.jp-btn-sub{ display:block; font-size:11px; opacity:.78; margin-top:2px; }

.jp-btn-glow{
  position:absolute;
  inset:-2px;
  border-radius: 20px;
  background: radial-gradient(circle at 20% 30%, rgba(255,255,255,.40), transparent 55%);
  opacity:.35;
  pointer-events:none;
  animation: glowPulse 1.8s ease-in-out infinite;
}
@keyframes glowPulse{
  0%,100%{ opacity:.25; }
  50%{ opacity:.55; }
}

.jp-note{
  margin-top: 12px;
  font-size: 12px;
  color: rgba(238,242,255,.60);
}

.petals{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:5;
}
.petal{
  position:absolute;
  top:-12%;
  width: 16px;
  height: 12px;
  background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.55), rgba(255,150,190,.65) 35%, rgba(255,90,130,.40) 70%, transparent 72%);
  border-radius: 14px 14px 14px 2px;
  filter: blur(.2px);
  opacity:.75;
  animation: fall var(--dur) linear var(--delay) infinite;
}
@keyframes fall{
  0%{
    transform: translate3d(var(--x), -12vh, 0) rotate(0deg);
    opacity: 0;
  }
  8%{ opacity: .85; }
  100%{
    transform: translate3d(calc(var(--x) + var(--drift)), 112vh, 0) rotate(360deg);
    opacity: 0;
  }
}

.jp-fx{
  position:absolute;
  inset:-40px;
  pointer-events:none;
  opacity:0;
  background:
    radial-gradient(900px 550px at 50% 45%, rgba(255,255,255,.16), transparent 60%),
    radial-gradient(900px 650px at 50% 55%, rgba(120,90,255,.20), transparent 62%),
    radial-gradient(900px 650px at 55% 50%, rgba(0,255,200,.16), transparent 62%);
  transform: scale(1);
  z-index:7;
}

/* saÃ­da mais devagar */
.jpGate.leaving .shoji.left{ animation: shojiLeft 1.55s cubic-bezier(.2,.9,.2,1) forwards; }
.jpGate.leaving .shoji.right{ animation: shojiRight 1.55s cubic-bezier(.2,.9,.2,1) forwards; }
@keyframes shojiLeft{ to{ transform: translateX(-105%); opacity:.98; } }
@keyframes shojiRight{ to{ transform: translateX(105%); opacity:.98; } }

.jpGate.leaving .jp-card{ animation: cardOut 1.05s ease forwards; }
@keyframes cardOut{ to{ opacity:0; transform: translateY(12px) scale(.985); } }

.jpGate.leaving .jp-bg{ animation: bgOut 1.65s ease forwards; }
@keyframes bgOut{ to{ transform: scale(1.12); opacity:0; } }

.jpGate.leaving .jp-fx{
  opacity:1;
  animation: fx 1.65s ease forwards;
}
@keyframes fx{
  0%{ transform: scale(1); opacity:0; }
  30%{ transform: scale(1.10); opacity:1; }
  100%{ transform: scale(1.38); opacity:0; }
}
</style>
</head>

<body>
<div id="flash" class="flash"></div>
<div id="toastWrap"></div>

<!-- ====== PORTAL / TELA DE ENTRADA ====== -->
<section id="gate" class="jpGate">
  <div class="jp-bg"></div>
  <canvas id="kanjiRain"></canvas>
  <div class="jp-pattern"></div>
  <div class="jp-scan"></div>

  <!-- ç„¡å¸¸ gigante -->
  <div class="mujo" aria-hidden="true">ç„¡å¸¸</div>

  <!-- TORII -->
  <div class="jp-torii" aria-hidden="true">
    <svg viewBox="0 0 1400 800" role="presentation">
      <defs>
        <linearGradient id="verm" x1="0" x2="1">
          <stop offset="0%" stop-color="rgba(255,90,90,.92)"/>
          <stop offset="35%" stop-color="rgba(255,70,120,.88)"/>
          <stop offset="70%" stop-color="rgba(190,90,255,.70)"/>
          <stop offset="100%" stop-color="rgba(255,255,255,.10)"/>
        </linearGradient>

        <filter id="patina" x="-30%" y="-30%" width="160%" height="160%">
          <feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="2" seed="9" result="n"/>
          <feColorMatrix in="n" type="matrix"
            values="1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 .10 0" result="a"/>
          <feComposite in="a" in2="SourceGraphic" operator="in" result="m"/>
          <feMerge>
            <feMergeNode in="m"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>

        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="8" result="b"/>
          <feColorMatrix in="b" type="matrix"
            values="1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 .45 0" result="g"/>
          <feMerge>
            <feMergeNode in="g"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <path d="M110 190 C 340 88, 1060 88, 1290 190 C 1060 165, 340 165, 110 190 Z"
            fill="url(#verm)" filter="url(#glow)"></path>

      <path d="M210 270 C 420 200, 980 200, 1190 270 C 980 252, 420 252, 210 270 Z"
            fill="rgba(255,255,255,.12)"></path>

      <path d="M320 360 C 460 318, 940 318, 1080 360 C 940 382, 460 382, 320 360 Z"
            fill="rgba(0,255,200,.10)"></path>

      <path d="M410 300 C 395 420, 380 610, 396 728 C 408 760, 470 760, 488 728 C 505 610, 488 420, 474 300 Z"
            fill="url(#verm)" filter="url(#patina)"></path>

      <path d="M926 300 C 912 420, 898 610, 914 728 C 926 760, 988 760, 1006 728 C 1022 610, 1006 420, 992 300 Z"
            fill="url(#verm)" filter="url(#patina)"></path>

      <path d="M684 330 C 675 440, 668 612, 674 728 C 683 754, 717 754, 726 728 C 733 612, 726 440, 716 330 Z"
            fill="rgba(255,255,255,.07)"></path>

      <path d="M372 728 C 420 696, 496 696, 544 728 C 496 760, 420 760, 372 728 Z"
            fill="rgba(255,255,255,.10)"></path>

      <path d="M870 728 C 918 696, 994 696, 1042 728 C 994 760, 918 760, 870 728 Z"
            fill="rgba(255,255,255,.10)"></path>

      <path d="M658 275 C 690 255, 720 255, 752 275 C 720 292, 690 292, 658 275 Z"
            fill="rgba(255,255,255,.08)"></path>
    </svg>
  </div>

  <div class="jp-vignette"></div>

  <div class="shoji left"></div>
  <div class="shoji right"></div>

  <div id="petals" class="petals"></div>

  <div class="jp-card">
    <div class="jp-kicker">ã‚ˆã†ã“ã</div>

    <div class="jp-title">
      yooo <span class="jp-glow">âœ¦</span>
    </div>

    <div class="jp-sub">
      SÃºditos do <b>ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢æ§˜</b> â€”
      <span class="jp-glitch" data-text="ã‚¿ãƒã‚³">ã‚¿ãƒã‚³</span>
    </div>

    <div class="jp-line"></div>

    <button id="enterBtn" class="jp-btn">
      <span class="jp-btn-main">å…¥ã‚‹</span>
      <span class="jp-btn-sub">Entrar</span>
      <span class="jp-btn-glow"></span>
    </button>

    <div class="jp-note">Enterã‚­ãƒ¼ã§ã‚‚OK</div>
  </div>

  <div id="gateFx" class="jp-fx"></div>
</section>

<!-- ====== APP (site real) ====== -->
<div id="app" class="appHidden">

<header>
  <div class="topbar">
    <div class="brand">
      <div class="t">ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½</div>
      <div class="s">Kanji <b>N5 + N4</b></div>
    </div>

    <nav>
      <div class="tabbtn active" id="tab-kanji">ğŸˆ¶ Kanji</div>
      <div class="tabbtn" id="tab-quiz">ğŸ® Jogo</div>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ====================== KANJI ====================== -->
  <section id="kanji" class="section active">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Kanji â€” Lista (N5 + N4)</h2>
            <p class="hint" id="kanjiCountHint">â€”</p>
          </div>

          <div class="row">
            <div class="small">Filtro</div>
            <select id="levelFilter">
              <option value="ALL" selected>ALL (N5+N4)</option>
              <option value="N5">Somente N5</option>
              <option value="N4">Somente N4</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="small">Pesquisar</div>
          <input id="kanjiSearch" type="text" placeholder="Ex: å­¦ / ãŒã / ã¾ãª / casa / mundo" />
          <div class="btn warn" id="clearSearch">Limpar</div>
        </div>

        <div class="kanjigrid" id="kanjigrid"></div>
      </div>

      <div class="panel" id="detailPanel">
        <h2>Detalhe</h2>
        <p class="hint">Selecione um kanji na lista.</p>

        <div id="kanjiDetail" class="card" style="display:none;">
          <div class="jp" id="kdKanji"></div>
          <div class="hira" id="kdReadings"></div>
          <div class="mean" id="kdMean"></div>
          <div class="badges" id="kdBadges"></div>

          <div class="strokeBox" id="kdStrokeBox">
            <div class="strokeHead">
              <div class="t">Ordem dos traÃ§os</div>
              <div class="row">
                <div class="btn primary" id="kdReplay">Repetir</div>
                <select id="kdSpeed" title="Velocidade">
                  <option value="0.7">RÃ¡pido</option>
                  <option value="1" selected>Normal</option>
                  <option value="1.35">Lento</option>
                </select>
              </div>
            </div>
            <div class="strokeBody" id="kdStroke"></div>
            <div class="strokeNote">Fonte: KanjiVG (SVG).</div>
          </div>

          <hr class="sep">
          <div class="row">
            <div class="btn good" id="kdTrain">Treinar no Jogo</div>
          </div>
        </div>

        <div id="kanjiDetailEmpty" class="card">
          <div class="mean" style="color:var(--muted);">Clique em um kanji para ver detalhes aqui.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== QUIZ ====================== -->
  <section id="quiz" class="section">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Jogo</h2>
            <p class="hint" id="reviewHint">Atalho: <b>P</b> = RevisÃ£o (sÃ³ aparece quando existir erro).</p>
          </div>

          <div class="row" style="justify-content:flex-end;">
            <label class="toggle" title="Repete mais os que vocÃª erra">
              <input type="checkbox" id="quizSmart" checked />
              modo inteligente
            </label>
            <label class="toggle" title="Reinicia automaticamente a cada questÃ£o">
              <input type="checkbox" id="quizAuto" checked />
              auto-run
            </label>

            <!-- container que some quando nÃ£o hÃ¡ erros -->
            <div id="reviewToggleWrap" style="display:none;">
              <label class="toggle" title="Somente kanjis errados (revisÃ£o)">
                <input type="checkbox" id="reviewOnly" />
                revisÃ£o (P)
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end;">
            <div style="flex:1;">
              <div class="bigKanji" id="quizKanji">ä¸€</div>
              <div class="badges" style="justify-content:center;">
                <span class="badge" id="quizScore">Acertos: 0 Â· Erros: 0 Â· Streak: 0</span>
                <span class="badge" id="quizTimerText">â±ï¸ 12s</span>
                <span class="badge tag" id="quizMoodText">Mood: â€”</span>
              </div>
              <div class="timerBarWrap">
                <div class="timerBar" id="timerBar"></div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <div class="small">NÃ­vel</div>
              <select id="quizLevel">
                <option value="ALL" selected>ALL</option>
                <option value="N5">N5</option>
                <option value="N4">N4</option>
              </select>

              <div class="small">Tempo</div>
              <select id="quizTime">
                <option value="8">8s</option>
                <option value="12" selected>12s</option>
                <option value="18">18s</option>
                <option value="25">25s</option>
              </select>

              <div class="btn good" id="quizStart">Start</div>
              <div class="btn warn" id="quizPause">Pausar</div>
              <div class="btn primary" id="quizNext">PrÃ³ximo</div>
              <div class="btn danger" id="quizReset">Zerar sessÃ£o</div>
            </div>
          </div>

          <hr class="sep">

          <div class="mcGrid">
            <div class="mcBox">
              <h3>Leitura</h3>
              <div class="choiceList" id="readingChoices"></div>
            </div>

            <div class="mcBox">
              <h3>Significado</h3>
              <div class="choiceList" id="meaningChoices"></div>
            </div>
          </div>

          <div id="quizFeedback" class="card" style="display:none;">
            <div class="mean" id="quizFeedbackTitle"></div>
            <div class="hira" id="quizFeedbackDetail"></div>

            <div class="strokeBox" style="margin-top:12px;">
              <div class="strokeHead">
                <div class="t">Ordem dos traÃ§os</div>
                <div class="row">
                  <div class="btn primary" id="quizReplay">Repetir</div>
                  <select id="quizSpeed" title="Velocidade">
                    <option value="0.7">RÃ¡pido</option>
                    <option value="1" selected>Normal</option>
                    <option value="1.35">Lento</option>
                  </select>
                </div>
              </div>
              <div class="strokeBody" id="quizStroke"></div>
              <div class="strokeNote">Fonte: KanjiVG.</div>
            </div>

            <!-- 3 vocÃ¡bulos -->
            <div class="vocab3" id="vocabBox">
              <h4>VocabulÃ¡rio (3 exemplos â€” PT-BR)</h4>
              <div class="small" id="vocabStatus">â€”</div>
              <div id="vocabList"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Ranking + EstatÃ­sticas</h2>
        <p class="hint">Salvo no navegador.</p>

        <div class="card">
          <div class="mean">ğŸ† Melhores marcas</div>
          <div class="small" id="bestStats">â€”</div>

          <hr class="sep">
          <div class="mean">ğŸ“Š Kanji mais errados</div>
          <div class="small" id="worstKanjis">â€”</div>

          <hr class="sep">
          <div class="mean">ğŸ§  RevisÃ£o (erros pendentes)</div>
          <div class="small" id="reviewList">â€”</div>

          <hr class="sep">
          <div class="row">
            <div class="btn danger" id="resetHistory">Resetar histÃ³rico</div>
            <div class="btn good" id="goKanji">Voltar ao Kanji</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½ Â© 2025</div>
</div>

<script>
/* =========================
   THEME CYCLE (a cada 5s)
========================= */
(function(){
  const hues = [195, 230, 265, 305, 20, 55, 110, 155];
  let i = Math.floor(Math.random() * hues.length);
  document.documentElement.style.setProperty("--themeHue", String(hues[i]));

  setInterval(()=>{
    i = (i + 1) % hues.length;
    document.documentElement.style.setProperty("--themeHue", String(hues[i]));
  }, 5000);
})();

/* =========================
   LISTAS DE NÃVEL
========================= */
const N5_LIST = [
  "ä¸€","ä¸ƒ","ä¸‡","ä¸‰","ä¸Š","ä¸‹","ä¸­","ä¹","äºŒ","äº”","äºº","ä»Š","ä¼‘","ä½•","å…ˆ","å…¥","å…«","å…­","å††","å‡º","åˆ†","å‰","åŒ—","å","åƒ","åˆ","åŠ","å—","å‹","å³","å","å››","å›½","åœŸ","å¤–","å¤§","å¤©","å¥³","å­","å­¦","å°","å±±","å·","å·¦","å¹´","å¾Œ","æ—¥","æ™‚","æ›¸","æœˆ","æœ¨","æœ¬","æ¥","æ±","æ ¡","æ¯","æ¯","æ°—","æ°´","ç«","çˆ¶","ç”Ÿ","ç”·","ç™½","ç™¾","è","è¡Œ","è¥¿","è¦‹","è©±","èª","èª­","è»Š","é‡‘","é•·","é–“","é›¨","é›»","é£Ÿ","é«˜"
];
const N4_LIST = [
  "ä¸","ä¸–","ä¸»","äº‹","äº¬","ä»•","ä»£","ä»¥","ä¼š","ä½","ä½“","ä½œ","ä½¿","å€Ÿ","å…ƒ","å…„","å…¬","å†™","å†¬","åˆ‡","åˆ¥","åŠ›","å‹‰","å‹•","åŒ»","å»","å£","å¤","å°","åŒ","å‘³","å“","å“¡","å•","å›³","åœ°","å ‚","å ´","å£²","å¤","å¤•","å¤š","å¤œ","å¦¹","å§‰","å§‹","å­—","å®‰","å®¤","å®¶","å°‘","å±‹","å·¥","å¸°","åºƒ","åº—","åº¦","å»º","å¼Ÿ","å¼·","å¾…","å¿ƒ","æ€","æ€¥","æ‚ª","æ„","æ‰‹","æŒ","æ•™","æ–‡","æ–™","æ–°","æ–¹","æ—…","æ—","æ—©","æ˜","æ˜ ","æ˜¥","æ˜¼","æ›œ","æœ‰","æœ","æœ","æ¥­","æ¥½","æ­Œ","æ­¢","æ­£","æ­©","æ­»","æ³¨","æ´‹","æµ·","æ¼¢","ç‰›","ç‰©","ç‰¹","çŠ¬","ç†","ç”¨","ç”°","ç”º","ç”»","ç•Œ","ç—…","ç™º","çš„","ç›®","çœŸ","ç€","çŸ¥","ç ”","ç¤¾","ç§","ç§‹","ç©¶","ç©º","ç«‹","ç­”","ç´™","çµ‚","ç¿’","è€ƒ","è€…","è‚‰","è‡ª","è‰²","èŠ±","è‹±","èŒ¶","è¦ª","è¨€","è¨ˆ","è©¦","è²·","è²¸","è³ª","èµ¤","èµ°","èµ·","è¶³","è»¢","è¿‘","é€","é€š","é€±","é‹","é“","é‡","é‡","éŠ€","é–‹","é™¢","é›†","é’","éŸ³","é¡Œ","é¢¨","é£¯","é£²","é¤¨","é§…","é¨“","é­š","é³¥","é»’"
];
const N5_SET = new Set(N5_LIST);
const N4_SET = new Set(N4_LIST);

/* =========================
   KANJI_INFO (PT-BR)
========================= */
const KANJI_INFO = {
  "ä¸€":{readings:["ã„ã¡","ã²ã¨"], meaning:"um"},
  "ä¸ƒ":{readings:["ã—ã¡","ãªãª"], meaning:"sete"},
  "ä¸‡":{readings:["ã¾ã‚“"], meaning:"dez mil"},
  "ä¸‰":{readings:["ã•ã‚“","ã¿ã£"], meaning:"trÃªs"},
  "ä¸Š":{readings:["ã†ãˆ","ã˜ã‚‡ã†"], meaning:"cima / sobre"},
  "ä¸‹":{readings:["ã—ãŸ","ã‹"], meaning:"baixo / descer"},
  "ä¸­":{readings:["ãªã‹","ã¡ã‚…ã†"], meaning:"meio / dentro"},
  "ä¹":{readings:["ãã‚…ã†","ã“ã“ã®"], meaning:"nove"},
  "äºŒ":{readings:["ã«","ãµãŸ"], meaning:"dois"},
  "äº”":{readings:["ã”","ã„ã¤"], meaning:"cinco"},
  "äºº":{readings:["ã²ã¨","ã«ã‚“"], meaning:"pessoa"},
  "ä»Š":{readings:["ã„ã¾","ã“ã‚“"], meaning:"agora"},
  "ä¼‘":{readings:["ã‚„ã™","ãã‚…ã†"], meaning:"descansar"},
  "ä½•":{readings:["ãªã«","ãªã‚“"], meaning:"o que"},
  "å…ˆ":{readings:["ã•ã","ã›ã‚“"], meaning:"antes / anterior"},
  "å…¥":{readings:["ã„","ã«ã‚…ã†"], meaning:"entrar"},
  "å…«":{readings:["ã¯ã¡","ã‚„"], meaning:"oito"},
  "å…­":{readings:["ã‚ã","ã‚€"], meaning:"seis"},
  "å††":{readings:["ãˆã‚“"], meaning:"iene / cÃ­rculo"},
  "å‡º":{readings:["ã§","ã—ã‚…ã¤"], meaning:"sair / aparecer"},
  "åˆ†":{readings:["ãµã‚“","ã¶ã‚“","ã‚"], meaning:"minuto / parte"},
  "å‰":{readings:["ã¾ãˆ","ãœã‚“"], meaning:"antes / frente"},
  "åŒ—":{readings:["ããŸ","ã»ã"], meaning:"norte"},
  "å":{readings:["ã˜ã‚…ã†","ã¨ãŠ"], meaning:"dez"},
  "åƒ":{readings:["ã›ã‚“"], meaning:"mil"},
  "åˆ":{readings:["ã”"], meaning:"meio-dia (åˆå‰/åˆå¾Œ)"},
  "åŠ":{readings:["ã¯ã‚“"], meaning:"metade"},
  "å—":{readings:["ã¿ãªã¿","ãªã‚“"], meaning:"sul"},
  "å‹":{readings:["ã¨ã‚‚","ã‚†ã†"], meaning:"amigo"},
  "å³":{readings:["ã¿ã","ã†"], meaning:"direita"},
  "å":{readings:["ãª","ã‚ã„"], meaning:"nome"},
  "å››":{readings:["ã‚ˆã‚“","ã—"], meaning:"quatro"},
  "å›½":{readings:["ãã«","ã“ã"], meaning:"paÃ­s"},
  "åœŸ":{readings:["ã¤ã¡","ã©"], meaning:"terra / solo"},
  "å¤–":{readings:["ãã¨","ãŒã„"], meaning:"fora"},
  "å¤§":{readings:["ãŠãŠ","ã ã„"], meaning:"grande"},
  "å¤©":{readings:["ã¦ã‚“","ã‚ã¾"], meaning:"cÃ©u"},
  "å¥³":{readings:["ãŠã‚“ãª","ã˜ã‚‡"], meaning:"mulher"},
  "å­":{readings:["ã“","ã—"], meaning:"crianÃ§a"},
  "å­¦":{readings:["ã¾ãª","ãŒã"], meaning:"estudar / estudo"},
  "å°":{readings:["ã¡ã„","ã—ã‚‡ã†"], meaning:"pequeno"},
  "å±±":{readings:["ã‚„ã¾","ã•ã‚“"], meaning:"montanha"},
  "å·":{readings:["ã‹ã‚","ã›ã‚“"], meaning:"rio"},
  "å·¦":{readings:["ã²ã ã‚Š","ã•"], meaning:"esquerda"},
  "å¹´":{readings:["ã¨ã—","ã­ã‚“"], meaning:"ano"},
  "å¾Œ":{readings:["ã‚ã¨","ã”"], meaning:"depois / atrÃ¡s"},
  "æ—¥":{readings:["ã²","ã«ã¡"], meaning:"dia / sol"},
  "æ™‚":{readings:["ã¨ã","ã˜"], meaning:"tempo / hora"},
  "æ›¸":{readings:["ã‹","ã—ã‚‡"], meaning:"escrever"},
  "æœˆ":{readings:["ã¤ã","ã’ã¤"], meaning:"mÃªs / lua"},
  "æœ¨":{readings:["ã","ã‚‚ã"], meaning:"Ã¡rvore / madeira"},
  "æœ¬":{readings:["ã»ã‚“","ã‚‚ã¨"], meaning:"livro / origem"},
  "æ¥":{readings:["ã","ã‚‰ã„"], meaning:"vir"},
  "æ±":{readings:["ã²ãŒã—","ã¨ã†"], meaning:"leste"},
  "æ ¡":{readings:["ã“ã†"], meaning:"escola"},
  "æ¯":{readings:["ã¯ã¯","ã¼"], meaning:"mÃ£e"},
  "æ¯":{readings:["ã¾ã„"], meaning:"cada / todo"},
  "æ°—":{readings:["ã"], meaning:"energia / humor"},
  "æ°´":{readings:["ã¿ãš","ã™ã„"], meaning:"Ã¡gua"},
  "ç«":{readings:["ã²","ã‹"], meaning:"fogo"},
  "çˆ¶":{readings:["ã¡ã¡","ãµ"], meaning:"pai"},
  "ç”Ÿ":{readings:["ã„","ã›ã„","ãªã¾"], meaning:"vida / nascer / cru"},
  "ç”·":{readings:["ãŠã¨ã“","ã ã‚“"], meaning:"homem"},
  "ç™½":{readings:["ã—ã‚","ã¯ã"], meaning:"branco"},
  "ç™¾":{readings:["ã²ã‚ƒã"], meaning:"cem"},
  "è":{readings:["ã","ã¶ã‚“"], meaning:"ouvir / perguntar"},
  "è¡Œ":{readings:["ã„","ã“ã†"], meaning:"ir / fazer"},
  "è¥¿":{readings:["ã«ã—","ã›ã„"], meaning:"oeste"},
  "è¦‹":{readings:["ã¿","ã‘ã‚“"], meaning:"ver / olhar"},
  "è©±":{readings:["ã¯ãª","ã‚"], meaning:"falar / conversa"},
  "èª":{readings:["ã”"], meaning:"idioma / palavra"},
  "èª­":{readings:["ã‚ˆ","ã©ã"], meaning:"ler"},
  "è»Š":{readings:["ãã‚‹ã¾","ã—ã‚ƒ"], meaning:"carro / veÃ­culo"},
  "é‡‘":{readings:["ã‹ã­","ãã‚“"], meaning:"dinheiro / ouro"},
  "é•·":{readings:["ãªãŒ","ã¡ã‚‡ã†"], meaning:"longo / chefe"},
  "é–“":{readings:["ã‚ã„ã ","ã‹ã‚“"], meaning:"intervalo / entre"},
  "é›¨":{readings:["ã‚ã‚","ã†"], meaning:"chuva"},
  "é›»":{readings:["ã§ã‚“"], meaning:"eletricidade"},
  "é£Ÿ":{readings:["ãŸ","ã—ã‚‡ã"], meaning:"comer / comida"},
  "é«˜":{readings:["ãŸã‹","ã“ã†"], meaning:"alto / caro"},

  "ä¸":{readings:["ãµ","ãªã„"], meaning:"nÃ£o / negativo"},
  "ä¸–":{readings:["ã›ã„","ã‚ˆ"], meaning:"mundo / sociedade"},
  "ä¸»":{readings:["ã—ã‚…","ã¬ã—"], meaning:"principal / dono"},
  "äº‹":{readings:["ã“ã¨","ã˜"], meaning:"coisa / assunto"},
  "äº¬":{readings:["ãã‚‡ã†","ã‘ã„"], meaning:"capital"},
  "ä»•":{readings:["ã—"], meaning:"servir / trabalho"},
  "ä»£":{readings:["ã ã„","ãŸã„","ã‹"], meaning:"substituir / era"},
  "ä»¥":{readings:["ã„"], meaning:"a partir de / por"},
  "ä¼š":{readings:["ã‹ã„","ã‚"], meaning:"encontro / reuniÃ£o"},
  "ä½":{readings:["ã™","ã˜ã‚…ã†"], meaning:"morar"},
  "ä½“":{readings:["ã‹ã‚‰ã ","ãŸã„"], meaning:"corpo"},
  "ä½œ":{readings:["ã¤ã","ã•ã"], meaning:"fazer / criar"},
  "ä½¿":{readings:["ã¤ã‹","ã—"], meaning:"usar"},
  "å€Ÿ":{readings:["ã‹","ã—ã‚ƒã"], meaning:"pegar emprestado"},
  "å…ƒ":{readings:["ã‚‚ã¨","ã’ã‚“"], meaning:"origem / ex-"},
  "å…„":{readings:["ã‚ã«","ãã‚‡ã†"], meaning:"irmÃ£o mais velho"},
  "å…¬":{readings:["ã“ã†","ãŠãŠã‚„ã‘"], meaning:"pÃºblico"},
  "å†™":{readings:["ã†ã¤","ã—ã‚ƒ"], meaning:"copiar / fotografar"},
  "å†¬":{readings:["ãµã‚†","ã¨ã†"], meaning:"inverno"},
  "åˆ‡":{readings:["ã","ã›ã¤"], meaning:"cortar"},
  "åˆ¥":{readings:["ã¹ã¤","ã‚ã‹"], meaning:"separar / diferente"},
  "åŠ›":{readings:["ã¡ã‹ã‚‰","ã‚Šã‚‡ã"], meaning:"forÃ§a"},
  "å‹‰":{readings:["ã¹ã‚“"], meaning:"esforÃ§o (å‹‰å¼·)"},
  "å‹•":{readings:["ã†ã”","ã©ã†"], meaning:"mover / movimento"},
  "åŒ»":{readings:["ã„"], meaning:"medicina / mÃ©dico"},
  "å»":{readings:["ã•","ãã‚‡"], meaning:"passado / ir embora"},
  "å£":{readings:["ãã¡","ã“ã†"], meaning:"boca"},
  "å¤":{readings:["ãµã‚‹","ã“"], meaning:"antigo"},
  "å°":{readings:["ã ã„","ãŸã„"], meaning:"base / suporte"},
  "åŒ":{readings:["ãŠãª","ã©ã†"], meaning:"mesmo"},
  "å‘³":{readings:["ã‚ã˜","ã¿"], meaning:"sabor"},
  "å“":{readings:["ã—ãª","ã²ã‚“"], meaning:"produto / item"},
  "å“¡":{readings:["ã„ã‚“"], meaning:"membro / funcionÃ¡rio"},
  "å•":{readings:["ã¨","ã‚‚ã‚“"], meaning:"perguntar / pergunta"},
  "å›³":{readings:["ãš","ã¯ã‹"], meaning:"diagrama / plano"},
  "åœ°":{readings:["ã¡","ã˜"], meaning:"terra / local"},
  "å ‚":{readings:["ã©ã†"], meaning:"salÃ£o / prÃ©dio"},
  "å ´":{readings:["ã°","ã˜ã‚‡ã†"], meaning:"lugar"},
  "å£²":{readings:["ã†","ã°ã„"], meaning:"vender"},
  "å¤":{readings:["ãªã¤","ã‹"], meaning:"verÃ£o"},
  "å¤•":{readings:["ã‚†ã†"], meaning:"tarde / entardecer"},
  "å¤š":{readings:["ãŠãŠ","ãŸ"], meaning:"muito"},
  "å¤œ":{readings:["ã‚ˆã‚‹","ã‚„"], meaning:"noite"},
  "å¦¹":{readings:["ã„ã‚‚ã†ã¨"], meaning:"irmÃ£ mais nova"},
  "å§‰":{readings:["ã‚ã­"], meaning:"irmÃ£ mais velha"},
  "å§‹":{readings:["ã¯ã˜","ã—"], meaning:"comeÃ§ar"},
  "å­—":{readings:["ã˜"], meaning:"caractere / letra"},
  "å®‰":{readings:["ã‚„ã™","ã‚ã‚“"], meaning:"barato / seguro"},
  "å®¤":{readings:["ã—ã¤"], meaning:"sala / quarto"},
  "å®¶":{readings:["ã„ãˆ","ã‹"], meaning:"casa / famÃ­lia"},
  "å°‘":{readings:["ã™ã“","ã—ã‚‡ã†"], meaning:"pouco"},
  "å±‹":{readings:["ã‚„"], meaning:"loja / profissÃ£o"},
  "å·¥":{readings:["ã“ã†","ã"], meaning:"trabalho / tÃ©cnica"},
  "å¸°":{readings:["ã‹ãˆ","ã"], meaning:"voltar"},
  "åºƒ":{readings:["ã²ã‚","ã“ã†"], meaning:"amplo / largo"},
  "åº—":{readings:["ã¿ã›","ã¦ã‚“"], meaning:"loja"},
  "åº¦":{readings:["ã©","ãŸã³"], meaning:"vez / grau"},
  "å»º":{readings:["ãŸ","ã‘ã‚“"], meaning:"construir"},
  "å¼Ÿ":{readings:["ãŠã¨ã†ã¨","ã ã„"], meaning:"irmÃ£o mais novo"},
  "å¼·":{readings:["ã¤ã‚ˆ","ãã‚‡ã†"], meaning:"forte"},
  "å¾…":{readings:["ã¾","ãŸã„"], meaning:"esperar"},
  "å¿ƒ":{readings:["ã“ã“ã‚","ã—ã‚“"], meaning:"coraÃ§Ã£o / mente"},
  "æ€":{readings:["ãŠã‚‚","ã—"], meaning:"pensar"},
  "æ€¥":{readings:["ã„ã","ãã‚…ã†"], meaning:"urgente / rÃ¡pido"},
  "æ‚ª":{readings:["ã‚ã‚‹","ã‚ã"], meaning:"ruim / mal"},
  "æ„":{readings:["ã„"], meaning:"intenÃ§Ã£o / ideia"},
  "æ‰‹":{readings:["ã¦","ã—ã‚…"], meaning:"mÃ£o"},
  "æŒ":{readings:["ã‚‚","ã˜"], meaning:"segurar / ter"},
  "æ•™":{readings:["ãŠã—","ãã‚‡ã†"], meaning:"ensinar"},
  "æ–‡":{readings:["ã¶ã‚“","ãµã¿"], meaning:"texto / frase"},
  "æ–™":{readings:["ã‚Šã‚‡ã†"], meaning:"taxa / material"},
  "æ–°":{readings:["ã‚ãŸã‚‰","ã—ã‚“"], meaning:"novo"},
  "æ–¹":{readings:["ã‹ãŸ","ã»ã†"], meaning:"lado / maneira"},
  "æ—…":{readings:["ãŸã³","ã‚Šã‚‡"], meaning:"viagem"},
  "æ—":{readings:["ãã"], meaning:"famÃ­lia / grupo"},
  "æ—©":{readings:["ã¯ã‚„","ãã†"], meaning:"cedo / rÃ¡pido"},
  "æ˜":{readings:["ã‚ã‹","ã‚ã„"], meaning:"claro / brilhante"},
  "æ˜ ":{readings:["ã†ã¤","ãˆã„"], meaning:"refletir / projetar"},
  "æ˜¥":{readings:["ã¯ã‚‹","ã—ã‚…ã‚“"], meaning:"primavera"},
  "æ˜¼":{readings:["ã²ã‚‹"], meaning:"dia / meio-dia"},
  "æ›œ":{readings:["ã‚ˆã†"], meaning:"dia da semana"},
  "æœ‰":{readings:["ã‚","ã‚†ã†"], meaning:"existir / ter"},
  "æœ":{readings:["ãµã"], meaning:"roupa"},
  "æœ":{readings:["ã‚ã•","ã¡ã‚‡ã†"], meaning:"manhÃ£"},
  "æ¥­":{readings:["ãã‚‡ã†","ã‚ã–"], meaning:"trabalho / atividade"},
  "æ¥½":{readings:["ãŸã®","ãŒã","ã‚‰ã"], meaning:"diversÃ£o / conforto"},
  "æ­Œ":{readings:["ã†ãŸ","ã‹"], meaning:"canÃ§Ã£o / cantar"},
  "æ­¢":{readings:["ã¨","ã—"], meaning:"parar"},
  "æ­£":{readings:["ãŸã ","ã›ã„"], meaning:"correto"},
  "æ­©":{readings:["ã‚ã‚‹","ã»"], meaning:"andar (a pÃ©)"},
  "æ­»":{readings:["ã—","ã—ã¬"], meaning:"morrer"},
  "æ³¨":{readings:["ãã","ã¡ã‚…ã†"], meaning:"despejar / atenÃ§Ã£o"},
  "æ´‹":{readings:["ã‚ˆã†"], meaning:"ocidental"},
  "æµ·":{readings:["ã†ã¿","ã‹ã„"], meaning:"mar"},
  "æ¼¢":{readings:["ã‹ã‚“"], meaning:"chinÃªs (æ¼¢)"},
  "ç‰›":{readings:["ã†ã—","ãã‚…ã†"], meaning:"boi / vaca"},
  "ç‰©":{readings:["ã‚‚ã®","ã¶ã¤"], meaning:"coisa / objeto"},
  "ç‰¹":{readings:["ã¨ã"], meaning:"especial"},
  "çŠ¬":{readings:["ã„ã¬","ã‘ã‚“"], meaning:"cachorro"},
  "ç†":{readings:["ã‚Š"], meaning:"razÃ£o / lÃ³gica"},
  "ç”¨":{readings:["ã‚ˆã†","ã‚‚ã¡"], meaning:"uso"},
  "ç”°":{readings:["ãŸ","ã§ã‚“"], meaning:"arrozal"},
  "ç”º":{readings:["ã¾ã¡","ã¡ã‚‡ã†"], meaning:"cidade / bairro"},
  "ç”»":{readings:["ãŒ","ãˆ"], meaning:"desenho / quadro"},
  "ç•Œ":{readings:["ã‹ã„"], meaning:"mundo / limite"},
  "ç—…":{readings:["ã‚„ã¾ã„","ã³ã‚‡ã†"], meaning:"doenÃ§a"},
  "ç™º":{readings:["ã¯ã¤","ã¯ã£"], meaning:"partida / emitir"},
  "çš„":{readings:["ã¦ã"], meaning:"alvo / sufixo -al"},
  "ç›®":{readings:["ã‚","ã‚‚ã"], meaning:"olho"},
  "çœŸ":{readings:["ã¾","ã—ã‚“"], meaning:"verdadeiro"},
  "ç€":{readings:["ã","ã¡ã‚ƒã"], meaning:"vestir / chegar"},
  "çŸ¥":{readings:["ã—","ã—ã‚‹"], meaning:"saber / conhecer"},
  "ç ”":{readings:["ã‘ã‚“","ã¨"], meaning:"pesquisa / polir"},
  "ç¤¾":{readings:["ã—ã‚ƒ"], meaning:"empresa / sociedade"},
  "ç§":{readings:["ã‚ãŸã—","ã—"], meaning:"eu / privado"},
  "ç§‹":{readings:["ã‚ã"], meaning:"outono"},
  "ç©¶":{readings:["ãã‚…ã†"], meaning:"investigar"},
  "ç©º":{readings:["ãã‚‰","ãã†"], meaning:"cÃ©u / vazio"},
  "ç«‹":{readings:["ãŸ","ã‚Šã¤"], meaning:"ficar em pÃ©"},
  "ç­”":{readings:["ã“ãŸ","ã¨ã†"], meaning:"responder / resposta"},
  "ç´™":{readings:["ã‹ã¿","ã—"], meaning:"papel"},
  "çµ‚":{readings:["ãŠ","ã—ã‚…ã†"], meaning:"terminar"},
  "ç¿’":{readings:["ãªã‚‰","ã—ã‚…ã†"], meaning:"aprender / praticar"},
  "è€ƒ":{readings:["ã‹ã‚“ãŒ","ã“ã†"], meaning:"pensar"},
  "è€…":{readings:["ã‚‚ã®","ã—ã‚ƒ"], meaning:"pessoa"},
  "è‚‰":{readings:["ã«ã"], meaning:"carne"},
  "è‡ª":{readings:["ã˜"], meaning:"si mesmo"},
  "è‰²":{readings:["ã„ã‚","ã—ã‚‡ã"], meaning:"cor"},
  "èŠ±":{readings:["ã¯ãª","ã‹"], meaning:"flor"},
  "è‹±":{readings:["ãˆã„"], meaning:"inglÃªs"},
  "èŒ¶":{readings:["ã¡ã‚ƒ","ã•"], meaning:"chÃ¡"},
  "è¦ª":{readings:["ãŠã‚„","ã—ã‚“"], meaning:"pais / Ã­ntimo"},
  "è¨€":{readings:["ã„","ã’ã‚“"], meaning:"dizer / palavra"},
  "è¨ˆ":{readings:["ã¯ã‹","ã‘ã„"], meaning:"medir / plano"},
  "è©¦":{readings:["ãŸã‚","ã—"], meaning:"testar"},
  "è²·":{readings:["ã‹","ã°ã„"], meaning:"comprar"},
  "è²¸":{readings:["ã‹","ãŸã„"], meaning:"emprestar (dar)"},
  "è³ª":{readings:["ã—ã¤"], meaning:"qualidade / pergunta"},
  "èµ¤":{readings:["ã‚ã‹","ã›ã"], meaning:"vermelho"},
  "èµ°":{readings:["ã¯ã—","ãã†"], meaning:"correr"},
  "èµ·":{readings:["ãŠ","ã"], meaning:"levantar / acontecer"},
  "è¶³":{readings:["ã‚ã—","ãã"], meaning:"pÃ©"},
  "è»¢":{readings:["ã“ã‚","ã¦ã‚“"], meaning:"girar / cair"},
  "è¿‘":{readings:["ã¡ã‹","ãã‚“"], meaning:"perto"},
  "é€":{readings:["ãŠã","ãã†"], meaning:"enviar"},
  "é€š":{readings:["ã¨ãŠ","ã¤ã†"], meaning:"passar / comunicar"},
  "é€±":{readings:["ã—ã‚…ã†"], meaning:"semana"},
  "é‹":{readings:["ã¯ã“","ã†ã‚“"], meaning:"transportar / sorte"},
  "é“":{readings:["ã¿ã¡","ã©ã†"], meaning:"caminho"},
  "é‡":{readings:["ãŠã‚‚","ã˜ã‚…ã†"], meaning:"pesado"},
  "é‡":{readings:["ã®","ã‚„"], meaning:"campo / interior"},
  "éŠ€":{readings:["ãã‚“"], meaning:"prata"},
  "é–‹":{readings:["ã‚","ã‹ã„"], meaning:"abrir"},
  "é™¢":{readings:["ã„ã‚“"], meaning:"instituiÃ§Ã£o"},
  "é›†":{readings:["ã‚ã¤","ã—ã‚…ã†"], meaning:"juntar / reunir"},
  "é’":{readings:["ã‚ãŠ","ã›ã„"], meaning:"azul / verde"},
  "éŸ³":{readings:["ãŠã¨","ãŠã‚“"], meaning:"som"},
  "é¡Œ":{readings:["ã ã„"], meaning:"tÃ­tulo / tema"},
  "é¢¨":{readings:["ã‹ãœ","ãµã†"], meaning:"vento"},
  "é£¯":{readings:["ã‚ã—","ã¯ã‚“"], meaning:"refeiÃ§Ã£o / arroz"},
  "é£²":{readings:["ã®","ã„ã‚“"], meaning:"beber"},
  "é¤¨":{readings:["ã‹ã‚“"], meaning:"prÃ©dio / estabelecimento"},
  "é§…":{readings:["ãˆã"], meaning:"estaÃ§Ã£o"},
  "é¨“":{readings:["ã‘ã‚“"], meaning:"experiÃªncia / teste"},
  "é­š":{readings:["ã•ã‹ãª","ãã‚‡"], meaning:"peixe"},
  "é³¥":{readings:["ã¨ã‚Š","ã¡ã‚‡ã†"], meaning:"pÃ¡ssaro"},
  "é»’":{readings:["ãã‚","ã“ã"], meaning:"preto"}
};

function isInfoComplete(k){
  const i = KANJI_INFO[k];
  return !!(i && i.meaning && Array.isArray(i.readings) && i.readings.length && i.readings[0] !== "â€”");
}

/* =========================
   HELPERS + UI SAFETY
========================= */
const $ = (id)=>document.getElementById(id);

function toast(title, msg, type="warn", ms=2200){
  const wrap = $("toastWrap");
  if(!wrap) return;
  const el = document.createElement("div");
  el.className = "toast " + type;
  el.innerHTML = `<div class="t">${title}</div><div class="m">${msg||""}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, ms);
  setTimeout(()=>{ el.remove(); }, ms + 260);
}

window.addEventListener("error", (e)=>{
  toast("Erro", (e?.message || "Ocorreu um erro.").slice(0,160), "bad", 2600);
});

function flash(type){
  const f = $("flash");
  f.className = "flash " + type;
  void f.offsetWidth;
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 560);
}
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function levelOf(k){
  if(N5_SET.has(k)) return "N5";
  if(N4_SET.has(k)) return "N4";
  return "N4";
}
function allKanjisUnique(){
  const set = new Set([...N5_LIST, ...N4_LIST]);
  return Array.from(set);
}
function poolByLevel(level){
  const all = allKanjisUnique().filter(isInfoComplete);
  if(level === "N5") return all.filter(k=>N5_SET.has(k));
  if(level === "N4") return all.filter(k=>N4_SET.has(k));
  return all;
}
function toHiragana(s){
  return (s||"").replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function normalizeSearch(s){
  return toHiragana((s||"").trim().toLowerCase());
}
function isKana(s){
  return /^[\u3040-\u309F\u30A0-\u30FFãƒ¼]+$/.test(s);
}
function isKanjiLike(s){
  return /[\u4E00-\u9FFF]/.test(s);
}
function safeInfo(k){
  const info = KANJI_INFO[k] || {readings:["â€”"], meaning:"â€”"};
  const r = (info.readings||[]).map(toHiragana).filter(Boolean);
  return { readings: r.length ? r : ["â€”"], meaning: info.meaning || "â€”" };
}

/* =========================
   TABS
========================= */
const sections = { kanji:$("kanji"), quiz:$("quiz") };
const tabs = { kanji:$("tab-kanji"), quiz:$("tab-quiz") };
function openTab(id){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  Object.values(tabs).forEach(t=>t.classList.remove("active"));
  sections[id].classList.add("active");
  tabs[id].classList.add("active");
  if(id==="kanji") renderKanjiGrid();
}
tabs.kanji.addEventListener("click", ()=>openTab("kanji"));
tabs.quiz.addEventListener("click", ()=>openTab("quiz"));

/* =========================
   STROKE ORDER (KanjiVG)
========================= */
const svgCache = new Map();
const strokeAnimState = new WeakMap();

function codepointHex5(ch){
  return ch.codePointAt(0).toString(16).padStart(5,"0");
}
function clearSVGAnimation(svg){
  const st = strokeAnimState.get(svg);
  if(st?.length) st.forEach(t=>clearTimeout(t));
  strokeAnimState.set(svg, []);
}
function pickStrokePaths(svg){
  const all = Array.from(svg.querySelectorAll("path"));
  const strokes = all.filter(p=>{
    const id = (p.getAttribute("id") || "");
    return /-s\d+/.test(id);
  });
  return strokes.length ? strokes : all;
}
function preparePaths(paths){
  for(const p of paths){
    p.style.fill = "none";
    p.style.stroke = "var(--accent2)";
    p.style.strokeWidth = "3.4";
    p.style.strokeLinecap = "round";
    p.style.strokeLinejoin = "round";
    p.style.opacity = "1";
    p.style.transition = "none";
  }
}
function animateStrokeOrder(svg, speed=1){
  if(!svg) return;
  clearSVGAnimation(svg);

  const paths = pickStrokePaths(svg);
  if(!paths.length) return;

  preparePaths(paths);

  const lengths = paths.map(p=>{
    let len = 160;
    try{ len = p.getTotalLength(); }catch{}
    p.style.strokeDasharray = String(len);
    p.style.strokeDashoffset = String(len);
    return len;
  });

  const timeouts = [];
  let cursor = 0;

  for(let i=0;i<paths.length;i++){
    const p = paths[i];
    const len = lengths[i];
    const dur = Math.max(220, Math.min(900, len*2.1)) * speed;

    const t = setTimeout(()=>{
      p.style.transition = `stroke-dashoffset ${dur}ms linear`;
      p.style.strokeDashoffset = "0";
    }, cursor);

    timeouts.push(t);
    cursor += dur + 85*speed;
  }
  strokeAnimState.set(svg, timeouts);
}

async function loadKanjiSVGInto(kanji, targetEl){
  if(svgCache.has(kanji)){
    targetEl.innerHTML = svgCache.get(kanji);
    return targetEl.querySelector("svg");
  }
  const hex = codepointHex5(kanji);
  const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
  targetEl.innerHTML = `<div class="small">Carregando stroke order...</div>`;
  try{
    const res = await fetch(url, {cache:"force-cache"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const svgText = await res.text();
    const cleaned = svgText
      .replace(/width="[^"]*"/g,'')
      .replace(/height="[^"]*"/g,'')
      .replace(/<\?xml[^>]*\?>/g,'');
    svgCache.set(kanji, cleaned);
    targetEl.innerHTML = cleaned;
    return targetEl.querySelector("svg");
  }catch{
    targetEl.innerHTML = `<div class="small">Falha ao carregar. Ctrl+F5 e tente novamente.</div>`;
    return null;
  }
}

/* =========================
   KANJI TAB + SEARCH
========================= */
const kanjigrid = $("kanjigrid");
const levelFilter = $("levelFilter");
const kanjiCountHint = $("kanjiCountHint");
const kanjiSearch = $("kanjiSearch");
const clearSearch = $("clearSearch");

const kdBox = $("kanjiDetail");
const kdEmpty = $("kanjiDetailEmpty");
const kdKanji = $("kdKanji");
const kdReadings = $("kdReadings");
const kdMean = $("kdMean");
const kdBadges = $("kdBadges");
const kdStroke = $("kdStroke");
const kdSpeed = $("kdSpeed");

let selectedKanji = null;
let kdSvgEl = null;

function matchesSearch(kanji, info, query){
  if(!query) return true;

  const q = normalizeSearch(query);
  const infoR = (info.readings||[]).map(normalizeSearch);
  const mean = normalizeSearch(info.meaning || "");

  if(isKanjiLike(query)) return kanji.includes(query.trim());
  if(isKana(query)) return infoR.some(r => r.includes(q));
  return mean.includes(q);
}

function renderKanjiGrid(){
  const level = levelFilter.value;
  const base = poolByLevel(level);

  const q = (kanjiSearch.value||"").trim();
  const out = [];
  for(const k of base){
    const info = safeInfo(k);
    if(matchesSearch(k, info, q)) out.push(k);
  }

  kanjiCountHint.textContent = `Mostrando: ${out.length} / ${base.length} (Total nÃ­vel) â€¢ Total geral: ${poolByLevel("ALL").length}`;

  kanjigrid.innerHTML = "";
  const frag = document.createDocumentFragment();

  for(const k of out){
    const lvl = levelOf(k);
    const div = document.createElement("div");
    div.className = "kanjiitem";
    div.innerHTML = `
      <div class="k">${k}</div>
      <div class="lvl"><b>${lvl}</b></div>
    `;
    div.addEventListener("click", ()=>showKanjiDetail(k, true));
    frag.appendChild(div);
  }
  kanjigrid.appendChild(frag);
}

levelFilter.addEventListener("change", ()=>{
  selectedKanji = null;
  kdSvgEl = null;
  kdBox.style.display = "none";
  kdEmpty.style.display = "block";
  renderKanjiGrid();
});
kanjiSearch.addEventListener("input", ()=>{
  if(window.__kSearchT) clearTimeout(window.__kSearchT);
  window.__kSearchT = setTimeout(()=>renderKanjiGrid(), 80);
});
clearSearch.addEventListener("click", ()=>{
  kanjiSearch.value = "";
  renderKanjiGrid();
});

async function showKanjiDetail(k, autoScroll){
  selectedKanji = k;

  kdEmpty.style.display="none";
  kdBox.style.display="block";

  const info = safeInfo(k);
  const lvl = levelOf(k);

  kdKanji.textContent = k;
  kdReadings.textContent = `Leituras: ${info.readings.join(" / ")}`;
  kdMean.textContent = `Significado: ${info.meaning}`;

  kdBadges.innerHTML = `
    <span class="badge ${lvl.toLowerCase()}">${lvl}</span>
    <span class="badge tag">kanji</span>
  `;

  if(autoScroll){
    $("detailPanel").scrollIntoView({behavior:"smooth", block:"start"});
    setTimeout(()=> $("kdStrokeBox").scrollIntoView({behavior:"smooth", block:"start"}), 250);
  }

  kdSvgEl = await loadKanjiSVGInto(k, kdStroke);
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
}

$("kdReplay").addEventListener("click", ()=>{
  if(!selectedKanji) return;
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
});
kdSpeed.addEventListener("change", ()=>{
  if(!selectedKanji) return;
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
});
$("kdTrain").addEventListener("click", ()=>{
  if(!selectedKanji) return;
  openTab("quiz");
  setQuestion(selectedKanji, true);
});

/* =========================
   REVISÃƒO (erros) â€” NÃƒO CAI + SOMENTE QUANDO EXISTE
========================= */
const reviewToggleWrap = $("reviewToggleWrap");
const reviewOnly = $("reviewOnly");
let reviewSet = new Set(); // kanjis errados pendentes

function updateReviewUI(){
  const arr = Array.from(reviewSet);
  $("reviewList").innerHTML = arr.length
    ? arr.map(k=>`<b>${k}</b>`).join("  ")
    : "â€”";

  if(arr.length){
    reviewToggleWrap.style.display = "block";
  }else{
    reviewToggleWrap.style.display = "none";
    if(reviewOnly) reviewOnly.checked = false;
  }
}

function safeEnableReview(on){
  const has = reviewSet.size > 0;
  if(!has){
    if(reviewOnly) reviewOnly.checked = false;
    updateReviewUI();
    flash("warn");
    toast("RevisÃ£o", "VocÃª ainda nÃ£o errou nenhum kanji. Sem revisÃ£o por enquanto.", "warn", 2200);
    return false;
  }
  if(reviewOnly) reviewOnly.checked = !!on;
  updateReviewUI();
  return true;
}

document.addEventListener("keydown", (e)=>{
  const tag = (e.target?.tagName || "").toLowerCase();
  const typing = (tag === "input" || tag === "textarea");
  if(typing) return;
  if(e.key === "p" || e.key === "P"){
    e.preventDefault();
    const targetState = !(reviewOnly?.checked);
    safeEnableReview(targetState);
    if(reviewOnly?.checked){
      toast("RevisÃ£o", "Modo revisÃ£o ligado (somente erros).", "good", 1800);
      nextQuestion();
    }else{
      toast("RevisÃ£o", "Modo revisÃ£o desligado (pool normal).", "warn", 1800);
      nextQuestion();
    }
  }
});

if(reviewOnly){
  reviewOnly.addEventListener("change", ()=>{
    if(reviewOnly.checked){
      if(!safeEnableReview(true)) return;
      toast("RevisÃ£o", "Somente kanjis errados.", "good", 1800);
      nextQuestion();
    }else{
      toast("RevisÃ£o", "Pool normal (ALL/N5/N4).", "warn", 1600);
      nextQuestion();
    }
  });
}

/* =========================
   QUIZ STATS
========================= */
const LS_KEY = "vampire_kanji_quiz_ptbr_v2";

function defaultStats(){
  return { bestStreak:0, bestAccuracy:0, bestScore:0, totalCorrect:0, totalWrong:0, perKanji:{}, recent:[] };
}
function loadStats(){
  try{ const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : defaultStats(); }
  catch{ return defaultStats(); }
}
function saveStats(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(stats)); }catch{} }
let stats = loadStats();

function ensurePerKanji(k){ if(!stats.perKanji[k]) stats.perKanji[k] = {c:0,w:0}; }
function pushRecent(ok){
  stats.recent.push(ok ? 1 : 0);
  if(stats.recent.length > 12) stats.recent.shift();
}
function moodScore(){
  if(!stats.recent.length) return 0.5;
  const sum = stats.recent.reduce((a,b)=>a+b,0);
  return sum / stats.recent.length;
}
function applyMood(){
  const s = moodScore();
  $("quizMoodText").textContent = `Mood: ${Math.round(s*100)}%`;
}

/* =========================
   QUIZ ENGINE
========================= */
const quizSmart = $("quizSmart");
const quizAuto = $("quizAuto");
const quizLevel = $("quizLevel");
const quizKanji = $("quizKanji");
const quizScoreEl = $("quizScore");
const quizTimerText = $("quizTimerText");
const timerBar = $("timerBar");
const quizTime = $("quizTime");

const readingChoices = $("readingChoices");
const meaningChoices = $("meaningChoices");

const quizFeedback = $("quizFeedback");
const quizFeedbackTitle = $("quizFeedbackTitle");
const quizFeedbackDetail = $("quizFeedbackDetail");
const quizStroke = $("quizStroke");
const quizSpeed = $("quizSpeed");

const bestStatsEl = $("bestStats");
const worstKanjisEl = $("worstKanjis");

const vocabStatus = $("vocabStatus");
const vocabList = $("vocabList");

let quizSvgEl = null;

$("goKanji").addEventListener("click", ()=> openTab("kanji"));
$("resetHistory").addEventListener("click", ()=>{
  stats = defaultStats();
  reviewSet = new Set();
  saveStats();
  updateRightPanel();
  updateReviewUI();
  applyMood();
  flash("bad");
  toast("Reset", "HistÃ³rico zerado.", "bad", 1800);
});

const quizState = {
  current: "ä¸€",
  running: false,
  timerId: null,
  timeLeftMs: 12000,
  timeTotalMs: 12000,

  sessionCorrect: 0,
  sessionWrong: 0,
  sessionStreak: 0,

  answeredReading: false,
  answeredMeaning: false,
  okReading: false,
  okMeaning: false,

  lockedAfterResult: false,
  lastPick: null
};

function updateScoreUI(){
  quizScoreEl.textContent =
    `Acertos: ${quizState.sessionCorrect} Â· Erros: ${quizState.sessionWrong} Â· Streak: ${quizState.sessionStreak}`;
}

function updateRightPanel(){
  const totalGlobal = stats.totalCorrect + stats.totalWrong;
  const accGlobal = totalGlobal ? (stats.totalCorrect / totalGlobal) : 0;

  bestStatsEl.innerHTML = `
    â€¢ Best streak: <b>${stats.bestStreak}</b><br>
    â€¢ Best accuracy: <b>${Math.round(stats.bestAccuracy*100)}%</b><br>
    â€¢ Best score (Câˆ’E): <b>${stats.bestScore}</b><br>
    â€¢ Global accuracy: <b>${Math.round(accGlobal*100)}%</b>
      (C:${stats.totalCorrect} / E:${stats.totalWrong})
  `;

  const arr = Object.entries(stats.perKanji).map(([k,v])=>{
    const total = v.c + v.w;
    const err = total ? (v.w / total) : 0;
    return {k, c:v.c, w:v.w, total, err};
  }).filter(x=>x.total>0);

  arr.sort((a,b)=> (b.w - a.w) || (b.err - a.err));
  const top = arr.slice(0,10);

  worstKanjisEl.innerHTML = top.length
    ? top.map(x=>{
        const pct = Math.round(x.err*100);
        return `â€¢ <b>${x.k}</b> â€” erros: ${x.w} / ${x.total} (${pct}%)`;
      }).join("<br>")
    : "â€”";

  updateReviewUI();
}

function updateBests(){
  stats.bestStreak = Math.max(stats.bestStreak, quizState.sessionStreak);
  const totalSession = quizState.sessionCorrect + quizState.sessionWrong;
  const accSession = totalSession ? (quizState.sessionCorrect / totalSession) : 0;
  const scoreSession = quizState.sessionCorrect - quizState.sessionWrong;
  stats.bestAccuracy = Math.max(stats.bestAccuracy, accSession);
  stats.bestScore = Math.max(stats.bestScore, scoreSession);
}

function readingText(k){ return safeInfo(k).readings.join(" / "); }
function meaningText(k){ return safeInfo(k).meaning; }

function buildChoices(kind, correctKanji, pool){
  const poolOthers = pool.filter(k => k !== correctKanji);

  const correctText =
    (kind === "reading") ? readingText(correctKanji) : meaningText(correctKanji);

  const picks = [{ text: correctText, correct: true }];

  const used = new Set([correctText]);
  const shuffled = shuffle(poolOthers);

  for(const k of shuffled){
    const t = (kind === "reading") ? readingText(k) : meaningText(k);
    if(!t || used.has(t)) continue;
    used.add(t);
    picks.push({ text: t, correct: false });
    if(picks.length === 4) break;
  }

  while(picks.length < 4){
    const k = poolOthers[Math.floor(Math.random() * poolOthers.length)];
    const t = (kind === "reading") ? readingText(k) : meaningText(k);
    if(!t || used.has(t)) continue;
    used.add(t);
    picks.push({ text: t, correct: false });
  }

  return shuffle(picks);
}

function resetQuestionState(){
  quizState.answeredReading = false;
  quizState.answeredMeaning = false;
  quizState.okReading = false;
  quizState.okMeaning = false;
  quizState.lockedAfterResult = false;
  quizFeedback.style.display = "none";
}

function disableAllChoices(){
  document.querySelectorAll(".choiceBtn").forEach(b=> b.disabled = true);
}

function renderChoiceButtons(targetEl, options, onPick){
  targetEl.innerHTML = "";
  for(const opt of options){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "choiceBtn";
    b.textContent = opt.text;

    b.addEventListener("click", ()=>{
      if(quizState.lockedAfterResult) return;

      const btns = Array.from(targetEl.querySelectorAll(".choiceBtn"));
      btns.forEach(btn=> btn.disabled = true);

      btns.forEach((btn, idx)=>{ if(options[idx].correct) btn.classList.add("correct"); });

      if(opt.correct) b.classList.add("correct");
      else b.classList.add("wrong");

      onPick(opt.correct);
    });

    targetEl.appendChild(b);
  }
}

function weightedPick(pool){
  let total = 0;
  const weights = pool.map(k=>{
    ensurePerKanji(k);
    const {c,w} = stats.perKanji[k];
    const unseen = (c+w===0) ? 1.0 : 0;
    const inReview = reviewSet.has(k) ? 0.65 : 0;
    const weight = Math.max(0.2, 1 + w*2.6 - c*0.30 + unseen + inReview);
    total += weight;
    return weight;
  });

  let r = Math.random() * total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function getBasePool(){
  const lvl = quizLevel.value;
  const pool = poolByLevel(lvl);
  return pool.length < 6 ? poolByLevel("ALL") : pool;
}
function getReviewPool(){
  const base = getBasePool();
  const only = base.filter(k => reviewSet.has(k));
  return only.length ? only : [];
}
function getQuizPool(){
  // Se revisÃ£o ligada e existirem erros, sÃ³ usa erros.
  if(reviewOnly && reviewOnly.checked){
    const rp = getReviewPool();
    if(rp.length) return rp;
    // nunca cai: desliga se ficar vazio
    if(reviewOnly) reviewOnly.checked = false;
    updateReviewUI();
    toast("RevisÃ£o", "Sua revisÃ£o acabou (nenhum erro pendente).", "good", 2200);
    return getBasePool();
  }
  return getBasePool();
}

function pickKanji(pool){
  let k = quizSmart.checked ? weightedPick(pool) : pool[Math.floor(Math.random()*pool.length)];
  if(pool.length > 1 && k === quizState.lastPick){
    k = pool[Math.floor(Math.random()*pool.length)];
  }
  quizState.lastPick = k;
  return k;
}

/* =========================
   VOCAB 3 EXEMPLOS â€” JPâ†’PT + filtro JLPT N4/N5
========================= */
/*
  Fontes:
  - DicionÃ¡rio JPâ†’PT (Yomichan) do elementare/jmdict_portuguese (term_bank_*.json)
  - Lista JLPTWords (palavraâ†’nÃ­vel) do Bluskyo/JLPT_Vocabulary (release v1.2)
*/
const JLPT_WORDS_URLS = [
  "https://github.com/Bluskyo/JLPT_Vocabulary/releases/download/v1.2/JLPTWords.json",
  "https://objects.githubusercontent.com/github-production-release-asset-2e65be/0/0?raw=1" // fallback genÃ©rico (se GitHub redirecionar)
];

const PT_DICT_BASE = "https://cdn.jsdelivr.net/gh/elementare/jmdict_portuguese@master/";
const PT_BANK_COUNT = 29;

let jlptWordLevel = null;          // Map(word -> "N5"/"N4"/...)
let jlptKanjiIndex = null;         // Map(kanjiChar -> {N5: [word], N4:[word]})
const ptTermCache = new Map();     // term -> {term, reading, meaning, score}
const ptLoadedBanks = new Set();   // loaded bank indices
let ptBankPromises = new Map();

function isCJKKanjiChar(ch){
  return /[\u4E00-\u9FFF]/.test(ch);
}
function normalizeJLPTLevel(v){
  // v pode vir como "N 5" ou "N5"
  const s = String(v||"").replace(/\s+/g,"").toUpperCase();
  if(/^N[1-5]$/.test(s)) return s;
  return null;
}

async function fetchJsonAny(urls){
  let lastErr = null;
  for(const url of urls){
    try{
      const r = await fetch(url, {cache:"force-cache", redirect:"follow"});
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("fetch failed");
}

async function ensureJLPTWords(){
  if(jlptWordLevel) return jlptWordLevel;

  // tentativa 1: GitHub release direto
  // se falhar (CORS), o fetch vai cair e a gente avisa
  try{
    const data = await fetchJsonAny(JLPT_WORDS_URLS);
    const m = new Map();
    for(const [w, lvl] of Object.entries(data||{})){
      const L = normalizeJLPTLevel(lvl);
      if(L) m.set(w, L);
    }
    jlptWordLevel = m;
    return jlptWordLevel;
  }catch(err){
    jlptWordLevel = new Map();
    toast("VocabulÃ¡rio", "Falha ao carregar JLPTWords.json (rede/CORS). Vou tentar ainda assim com o dicionÃ¡rio PT.", "warn", 3000);
    return jlptWordLevel;
  }
}

async function ensureJLPTKanjiIndex(){
  if(jlptKanjiIndex) return jlptKanjiIndex;

  const map = await ensureJLPTWords();
  const idx = new Map();

  // indexa sÃ³ N4/N5 porque vocÃª pediu
  for(const [word, lvl] of map.entries()){
    if(lvl !== "N5" && lvl !== "N4") continue;
    if(!word || typeof word !== "string") continue;
    if(word.length > 12) continue; // corta frases gigantes

    const chars = Array.from(word);
    const unique = new Set(chars.filter(isCJKKanjiChar));
    for(const ch of unique){
      if(!idx.has(ch)) idx.set(ch, {N5:[], N4:[]});
      idx.get(ch)[lvl].push(word);
    }
  }

  jlptKanjiIndex = idx;
  return jlptKanjiIndex;
}

function parseGlossary(gloss){
  // gloss pode ser string, array de strings ou objetos
  if(!gloss) return "";
  if(typeof gloss === "string") return gloss;
  if(Array.isArray(gloss)){
    const parts = [];
    for(const g of gloss){
      if(typeof g === "string") parts.push(g);
      else if(g && typeof g === "object"){
        if(typeof g.content === "string") parts.push(g.content);
        else if(typeof g.text === "string") parts.push(g.text);
      }
      if(parts.length >= 2) break;
    }
    return parts.join("; ");
  }
  if(typeof gloss === "object"){
    if(typeof gloss.content === "string") return gloss.content;
    if(typeof gloss.text === "string") return gloss.text;
  }
  return "";
}

function parseTermEntry(entry){
  // formato yomichan: [term, reading, defTags, rules, score, glossary, seq, termTags]
  if(!Array.isArray(entry)) return null;
  const term = entry[0];
  const reading = entry[1];
  const score = Number(entry[4] ?? 0);
  const glossary = entry[5];
  const meaning = parseGlossary(glossary);
  if(!term || !meaning) return null;
  return {term, reading: reading || "", meaning, score};
}

async function loadPTBank(i){
  if(ptLoadedBanks.has(i)) return true;
  if(ptBankPromises.has(i)) return ptBankPromises.get(i);

  const p = (async ()=>{
    const url = PT_DICT_BASE + `term_bank_${i}.json`;
    try{
      const r = await fetch(url, {cache:"force-cache"});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();
      // nÃ£o indexa tudo (pesado). Apenas varre e guarda conforme for solicitado.
      // Mas vamos aproveitar para capturar "top termos comuns" do banco: nada.
      ptLoadedBanks.add(i);
      return data;
    }catch(e){
      return null;
    }finally{
      // keep promise
    }
  })();

  ptBankPromises.set(i, p);
  return p;
}

async function lookupPortugueseTerm(term){
  if(ptTermCache.has(term)) return ptTermCache.get(term);

  // EstratÃ©gia:
  // - carrega bancos progressivamente atÃ© encontrar
  // - para ser "eficiente", para quando achar algo bom
  let best = null;

  for(let i=1;i<=PT_BANK_COUNT;i++){
    const bank = await loadPTBank(i);
    if(!bank) continue;

    // varre por matches (termo exato)
    for(const entry of bank){
      if(entry && entry[0] === term){
        const parsed = parseTermEntry(entry);
        if(parsed){
          if(!best || parsed.score > best.score) best = parsed;
          // se score muito alto, para cedo
          if(best.score >= 5000) break;
        }
      }
    }
    if(best && best.score >= 5000) break;
  }

  if(best){
    ptTermCache.set(term, best);
    return best;
  }

  ptTermCache.set(term, null);
  return null;
}

function kanjiJLPTLevel(kanji){
  // regra que vocÃª pediu: se o KANJI Ã© N5 -> pega vocabulÃ¡rio N5, se N4 -> vocabulÃ¡rio N4
  return levelOf(kanji); // "N5" ou "N4"
}

async function get3VocabForKanji(kanji){
  const targetLevel = kanjiJLPTLevel(kanji);

  // pega candidatos do Ã­ndice JLPTWords
  const idx = await ensureJLPTKanjiIndex();
  const bucket = idx.get(kanji);
  const candidates = bucket ? (bucket[targetLevel] || []) : [];

  if(!candidates.length){
    return { level: targetLevel, items: [], note: "NÃ£o achei palavras JLPT (N4/N5) para este kanji nesta base." };
  }

  // para reduzir custo, tenta um subconjunto primeiro
  // (muitos candidatos podem existir; a gente quer 3 "bons")
  const sample = shuffle(candidates).slice(0, Math.min(60, candidates.length));

  const found = [];
  for(const w of sample){
    // corta termos com sÃ­mbolos/espacos estranhos
    if(/[ ã€€]/.test(w)) continue;
    if(w.length > 10) continue;

    const data = await lookupPortugueseTerm(w);
    if(data && data.meaning){
      found.push(data);
      if(found.length >= 12) break; // junta um pool e rankeia
    }
  }

  if(!found.length){
    return { level: targetLevel, items: [], note: "Encontrei candidatos JLPT, mas nÃ£o consegui casar com o dicionÃ¡rio PT (rede/limite/cobertura)." };
  }

  // ranking: score desc, depois tamanho asc
  found.sort((a,b)=> (b.score - a.score) || (a.term.length - b.term.length));
  const top3 = [];
  const seen = new Set();
  for(const it of found){
    if(seen.has(it.term)) continue;
    seen.add(it.term);
    top3.push(it);
    if(top3.length === 3) break;
  }

  return { level: targetLevel, items: top3, note: top3.length < 3 ? "NÃ£o deu 3 completos (cobertura/limite), mostrei o que deu." : "" };
}

function renderVocabBoxLoading(kanji){
  vocabList.innerHTML = "";
  vocabStatus.textContent = `Carregando 3 vocÃ¡bulos (${kanjiJLPTLevel(kanji)})...`;
}

function renderVocabBoxEmpty(msg){
  vocabList.innerHTML = "";
  vocabStatus.textContent = msg || "â€”";
}

function renderVocabItems(items){
  vocabList.innerHTML = "";
  for(const it of items){
    const el = document.createElement("div");
    el.className = "vocabItem";
    const r = (it.reading || "").trim();
    const m = (it.meaning || "").trim();
    el.innerHTML = `
      <div class="vocabTop">
        <div class="vocabWord">${it.term}</div>
        <div class="vocabReading">${r ? `(${toHiragana(r)})` : ""}</div>
      </div>
      <div class="vocabMeaning">${m || "â€”"}</div>
    `;
    vocabList.appendChild(el);
  }
}

async function renderVocabForKanji(kanji){
  try{
    renderVocabBoxLoading(kanji);
    const res = await get3VocabForKanji(kanji);
    if(!res.items.length){
      renderVocabBoxEmpty(`Sem exemplos (${res.level}). ${res.note || ""}`.trim());
      return;
    }
    vocabStatus.textContent = `NÃ­vel alvo: ${res.level}${res.note ? " â€¢ " + res.note : ""}`;
    renderVocabItems(res.items);
  }catch(e){
    renderVocabBoxEmpty("Falha ao carregar vocabulÃ¡rio (rede/CORS).");
    toast("VocabulÃ¡rio", "Falha ao montar 3 exemplos.", "warn", 2600);
  }
}

/* =========================
   QUIZ FLOW
========================= */
async function showFeedback(okAll, reason){
  const k = quizState.current;
  const info = safeInfo(k);

  quizFeedback.style.display = "block";
  quizFeedbackTitle.innerHTML = okAll
    ? `âœ… <b>Acertou</b>`
    : (reason === "timeout" ? `â±ï¸ <b>Tempo esgotado</b>` : `âŒ <b>Errou</b>`);

  quizFeedbackDetail.innerHTML = `
    Kanji: <b>${k}</b> Â· <b>${levelOf(k)}</b><br>
    Leituras: <b>${info.readings.join(" / ")}</b><br>
    Significado: <b>${info.meaning}</b>
  `;

  quizSvgEl = await loadKanjiSVGInto(k, quizStroke);
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));

  // 3 vocÃ¡bulos
  renderVocabForKanji(k);
}

function commitResult(okAll, reason){
  const k = quizState.current;
  ensurePerKanji(k);

  if(okAll){
    quizState.sessionCorrect += 1;
    quizState.sessionStreak += 1;
    stats.totalCorrect += 1;
    stats.perKanji[k].c += 1;
    pushRecent(true);
    flash("good");

    // Se estava na revisÃ£o (errado pendente), "resetar": remove quando acertar.
    if(reviewSet.has(k)){
      reviewSet.delete(k);
      updateReviewUI();
      if(reviewOnly && reviewOnly.checked && reviewSet.size === 0){
        // termina revisÃ£o automaticamente
        reviewOnly.checked = false;
        updateReviewUI();
        toast("RevisÃ£o", "VocÃª limpou todos os erros. RevisÃ£o encerrada.", "good", 2400);
      }
    }
  }else{
    quizState.sessionWrong += 1;
    quizState.sessionStreak = 0;
    stats.totalWrong += 1;
    stats.perKanji[k].w += 1;
    pushRecent(false);
    flash("bad");

    // adiciona a lista de revisÃ£o
    reviewSet.add(k);
    updateReviewUI();
  }

  updateScoreUI();
  updateBests();
  applyMood();
  updateRightPanel();
  saveStats();

  stopTimer();
  disableAllChoices();

  quizState.lockedAfterResult = true;
  showFeedback(okAll, reason);
}

function evaluateIfComplete(){
  if(!(quizState.answeredReading && quizState.answeredMeaning)) return;
  const okAll = quizState.okReading && quizState.okMeaning;
  commitResult(okAll, "answered");
}

function setQuestion(kanji, keepTimerRunning){
  quizState.current = kanji;
  quizKanji.textContent = kanji;

  resetQuestionState();

  const pool = getQuizPool();
  // seguranÃ§a: se pool vier vazio por algum bug, cai para base
  const safePool = pool.length ? pool : getBasePool();

  const rOpts = buildChoices("reading", kanji, safePool);
  const mOpts = buildChoices("meaning", kanji, safePool);

  renderChoiceButtons(readingChoices, rOpts, (ok)=>{
    quizState.answeredReading = true;
    quizState.okReading = ok;
    evaluateIfComplete();
  });

  renderChoiceButtons(meaningChoices, mOpts, (ok)=>{
    quizState.answeredMeaning = true;
    quizState.okMeaning = ok;
    evaluateIfComplete();
  });

  if(quizState.running){
    startTimer(true);
  }else if(!keepTimerRunning){
    const seconds = Number(quizTime.value);
    quizState.timeTotalMs = seconds * 1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }else{
    if(quizAuto.checked) startTimer(true);
    else{
      const seconds = Number(quizTime.value);
      quizState.timeTotalMs = seconds * 1000;
      quizState.timeLeftMs = quizState.timeTotalMs;
      updateTimerUI();
    }
  }
}

function nextQuestion(){
  const pool = getQuizPool();
  const safePool = pool.length ? pool : getBasePool();
  setQuestion(pickKanji(safePool), true);
}

/* =========================
   TIMER
========================= */
function updateTimerUI(){
  const leftSec = Math.max(0, Math.ceil(quizState.timeLeftMs/1000));
  quizTimerText.textContent = `â±ï¸ ${leftSec}s`;
  const pct = quizState.timeTotalMs ? (quizState.timeLeftMs/quizState.timeTotalMs) : 0;
  timerBar.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
}
function stopTimer(){
  if(quizState.timerId){
    clearInterval(quizState.timerId);
    quizState.timerId = null;
  }
  quizState.running = false;
}
function startTimer(reset){
  const seconds = Number(quizTime.value);
  quizState.timeTotalMs = seconds*1000;
  if(reset) quizState.timeLeftMs = quizState.timeTotalMs;

  stopTimer();
  quizState.running = true;

  quizState.timerId = setInterval(()=>{
    if(quizState.lockedAfterResult) return;
    quizState.timeLeftMs -= 200;
    updateTimerUI();
    if(quizState.timeLeftMs <= 0){
      stopTimer();
      if(!quizState.lockedAfterResult) commitResult(false, "timeout");
    }
  }, 200);

  updateTimerUI();
}

/* =========================
   CONTROLES QUIZ
========================= */
$("quizStart").addEventListener("click", ()=>{
  if(quizState.lockedAfterResult) return;
  startTimer(true);
});
$("quizPause").addEventListener("click", ()=>{
  if(quizState.lockedAfterResult) return;
  if(quizState.running) stopTimer();
  else startTimer(false);
});
$("quizNext").addEventListener("click", ()=>{
  nextQuestion();
  updateRightPanel();
  saveStats();
});
$("quizReset").addEventListener("click", ()=>{
  stopTimer();
  quizState.sessionCorrect = 0;
  quizState.sessionWrong = 0;
  quizState.sessionStreak = 0;
  updateScoreUI();
  updateRightPanel();
  saveStats();
  flash("bad");
  nextQuestion();
});

quizTime.addEventListener("change", ()=>{
  if(quizState.lockedAfterResult) return;
  if(quizState.running) startTimer(true);
  else{
    quizState.timeTotalMs = Number(quizTime.value)*1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
});
$("quizReplay").addEventListener("click", ()=>{
  if(!quizSvgEl) return;
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));
});
quizSpeed.addEventListener("change", ()=>{
  if(!quizSvgEl) return;
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));
});
quizLevel.addEventListener("change", ()=> nextQuestion());

/* =========================
   INIT
========================= */
function init(){
  renderKanjiGrid();
  updateRightPanel();
  updateReviewUI();
  applyMood();
  updateScoreUI();
  setQuestion("ä¸€", false);
}
init();

/* =========================
   PORTAL / ENTRADA â€” CHUVA DE KANJI
========================= */
(function(){
  const gate = document.getElementById("gate");
  const app  = document.getElementById("app");
  const btn  = document.getElementById("enterBtn");
  const petalsBox = document.getElementById("petals");
  const canvas = document.getElementById("kanjiRain");
  if(!gate || !app || !btn || !petalsBox) return;

  // KANJI RAIN
  const ctx = canvas?.getContext?.("2d");
  let rainRAF = null;
  let drops = [];
  const rainChars = allKanjisUnique();

  function resizeRain(){
    if(!canvas || !ctx) return;
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const cols = Math.floor(window.innerWidth / 22);
    drops = new Array(cols).fill(0).map((_,i)=>({
      x: i * 22 + (Math.random()*10 - 5),
      y: Math.random() * window.innerHeight,
      sp: 2.2 + Math.random()*3.6,
      size: 14 + Math.random()*12,
      trail: 8 + Math.floor(Math.random()*16),
      hue: 170 + Math.random()*140
    }));
  }

  function drawRain(){
    if(!ctx || !canvas) return;
    ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

    // leve â€œfadeâ€ para rastro
    ctx.fillStyle = "rgba(10,14,20,0.10)";
    ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

    for(const d of drops){
      d.y += d.sp;
      if(d.y > window.innerHeight + d.trail * d.size){
        d.y = -Math.random()*200;
        d.sp = 2.0 + Math.random()*4.2;
        d.size = 14 + Math.random()*12;
        d.trail = 8 + Math.floor(Math.random()*16);
        d.hue = 170 + Math.random()*140;
      }

      ctx.font = `${Math.floor(d.size)}px "Yu Gothic", system-ui, sans-serif`;
      for(let t=0;t<d.trail;t++){
        const ch = rainChars[(Math.random()*rainChars.length)|0] || "ç„¡";
        const yy = d.y - t * (d.size * 1.15);
        const a = Math.max(0, 0.95 - t*(0.95/d.trail));
        ctx.fillStyle = `hsla(${d.hue}, 92%, 70%, ${a*0.35})`;
        ctx.fillText(ch, d.x, yy);
      }

      // cabeÃ§a mais brilhante
      const head = rainChars[(Math.random()*rainChars.length)|0] || "ç„¡";
      ctx.fillStyle = `hsla(${d.hue}, 95%, 86%, .55)`;
      ctx.fillText(head, d.x, d.y);
    }

    rainRAF = requestAnimationFrame(drawRain);
  }

  function startRain(){
    if(!canvas || !ctx) return;
    resizeRain();
    cancelAnimationFrame(rainRAF);
    drawRain();
  }
  function stopRain(){
    cancelAnimationFrame(rainRAF);
    rainRAF = null;
  }

  // petals
  function spawnPetals(n=28){
    petalsBox.innerHTML = "";
    for(let i=0;i<n;i++){
      const p = document.createElement("span");
      p.className = "petal";

      const x = Math.random()*100;
      const drift = (Math.random()*40 - 20);
      const dur = 11 + Math.random()*9;
      const delay = Math.random()*4;

      p.style.setProperty("--x", `${x}vw`);
      p.style.setProperty("--drift", `${drift}vw`);
      p.style.setProperty("--dur", `${dur}s`);
      p.style.setProperty("--delay", `${delay}s`);

      const scale = 0.75 + Math.random()*1.1;
      p.style.width  = `${16*scale}px`;
      p.style.height = `${12*scale}px`;

      petalsBox.appendChild(p);
    }
  }

  function chime(){
    try{
      const ctxA = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctxA.createOscillator();
      const g = ctxA.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(880, ctxA.currentTime);
      o.frequency.exponentialRampToValueAtTime(1320, ctxA.currentTime + 0.10);
      g.gain.setValueAtTime(0.0001, ctxA.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctxA.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctxA.currentTime + 0.22);
      o.connect(g); g.connect(ctxA.destination);
      o.start();
      o.stop(ctxA.currentTime + 0.24);
      setTimeout(()=>ctxA.close?.(), 380);
    }catch{}
  }

  spawnPetals(30);
  startRain();

  function enter(){
    gate.classList.add("leaving");
    btn.disabled = true;
    chime();

    setTimeout(()=>{
      stopRain();
      gate.style.display = "none";
      app.classList.remove("appHidden");
      window.scrollTo(0,0);
      toast("Bem-vindo", "Que comece a caÃ§ada. ğŸ¦‡", "good", 2200);
    }, 1700);
  }

  btn.addEventListener("click", enter);
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && gate.style.display !== "none") enter();
  });

  let t=null;
  window.addEventListener("resize", ()=>{
    clearTimeout(t);
    t=setTimeout(()=>{
      spawnPetals(30);
      resizeRain();
    }, 180);
  });
})();
</script>

</div><!-- fecha #app -->
</body>
</html>
