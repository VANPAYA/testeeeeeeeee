<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ‚Äî Kanji & Jogo</title>

<style>
:root{
  --bg:#0b0f14;
  --border:rgba(255,255,255,.16);
  --text:#eef2ff;
  --muted:rgba(238,242,255,.72);
  --muted2:rgba(238,242,255,.55);

  /* THEME (muda a cada 5s) */
  --themeHue: 195;

  /* Mood (s√≥ indicador do jogo) */
  --moodHue: 195;

  --accent:  hsl(calc(var(--themeHue) - 25) 90% 60%);
  --accent2: hsl(var(--themeHue) 90% 58%);
  --accent3: hsl(calc(var(--themeHue) + 55) 90% 62%);

  --good:#34d399;
  --bad:#fb7185;
  --warn:#fbbf24;

  --radius:18px;
  --shadow: 0 18px 60px rgba(0,0,0,.55);

  --selectBg:#0f1826;
  --selectBorder:rgba(255,255,255,.28);

  --inputBg:#0f1826;
  --inputBorder:rgba(255,255,255,.28);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  color:var(--text);
  font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",system-ui,sans-serif;
  line-height:1.9;
  background:
    radial-gradient(1100px 650px at 12% 10%, hsla(calc(var(--themeHue) - 25), 90%, 60%, .22), transparent 55%),
    radial-gradient(900px 600px at 92% 15%, hsla(var(--themeHue), 90%, 58%, .18), transparent 55%),
    radial-gradient(900px 650px at 20% 92%, hsla(calc(var(--themeHue) + 55), 90%, 62%, .14), transparent 55%),
    var(--bg);
  transition: background .65s ease, filter .65s ease;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(10,14,20,.78);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border);
}

.topbar{
  max-width:1180px;
  margin:auto;
  padding:18px 18px 12px;
  display:flex;
  gap:16px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}

.brand{ min-width:280px; }
.brand .t{ font-size:20px; font-weight:900; letter-spacing:1.2px; }
.brand .s{ margin-top:6px; color:var(--muted); font-size:13px; }
.brand .s b{ color:var(--text); }

nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

.container{ max-width:1180px; margin:auto; padding:34px 18px 90px; }

.section{ display:none; }
.section.active{ display:block; }

.grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; }
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

.panel{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:22px;
  padding:16px;
  box-shadow: var(--shadow);
}
.panel h2{ margin:0 0 8px; font-size:15px; letter-spacing:.6px; }

.hint{ color:var(--muted); font-size:13px; margin:0; }

.row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }

.card{
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  border-radius: var(--radius);
  padding:16px;
  margin-top:12px;
}

.jp{ font-size:22px; font-weight:900; color: var(--accent2); letter-spacing:.6px; }
.hira{ margin-top:6px; color:var(--muted); font-size:13px; }
.mean{ margin-top:8px; font-size:14px; font-weight:700; }

.badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  color:var(--muted);
  background: rgba(255,255,255,.06);
}
.badge.n5{ border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95); }
.badge.n4{ border-color: rgba(59,130,246,.45); color: rgba(147,197,253,.95); }
.badge.tag{ border-color: rgba(255,255,255,.22); color: var(--text); }

.tabbtn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.10);
  color: rgba(238,242,255,.92);
  padding:10px 14px;
  border-radius:999px;
  font-size:13px;
  user-select:none;
  box-shadow: var(--shadow);
  transition: transform .08s ease, background .18s ease, border-color .18s ease;
}
.tabbtn:hover{ background: rgba(255,255,255,.14); }
.tabbtn:active{ transform: translateY(1px); }
.tabbtn.active{
  border-color: hsla(var(--themeHue), 90%, 60%, .60);
  background: hsla(var(--themeHue), 90%, 55%, .22);
}

.btn{
  cursor:pointer;
  border:1px solid rgba(255,255,255,.28);
  background: rgba(255,255,255,.12);
  color: rgba(255,255,255,.98);
  padding:9px 12px;
  border-radius:14px;
  font-size:12px;
  font-weight:800;
  user-select:none;
  transition: transform .08s ease, background .18s ease, border-color .18s ease;
}
.btn:hover{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.38); }
.btn:active{ transform: translateY(1px); }
.btn.primary{
  border-color: hsla(var(--themeHue), 90%, 60%, .70);
  background: hsla(var(--themeHue), 90%, 55%, .26);
}
.btn.good{ border-color: rgba(52,211,153,.75); background: rgba(52,211,153,.20); }
.btn.danger{ border-color: rgba(251,113,133,.75); background: rgba(251,113,133,.18); }
.btn.warn{ border-color: rgba(251,191,36,.75); background: rgba(251,191,36,.18); }

select{
  padding:9px 11px;
  border-radius:12px;
  border:1px solid var(--selectBorder);
  background: var(--selectBg);
  color: rgba(255,255,255,.96);
  outline:none;
  font-weight:900;
}
input[type="text"]{
  padding:9px 11px;
  border-radius:12px;
  border:1px solid var(--inputBorder);
  background: var(--inputBg);
  color: rgba(255,255,255,.96);
  outline:none;
  font-weight:900;
  min-width: 240px;
}
input[type="text"]::placeholder{ color: rgba(238,242,255,.55); font-weight:700; }

.kanjigrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  gap:12px;
  margin-top:12px;
}

.kanjiitem{
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.20);
  border-radius: 16px;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition: transform .12s ease, border-color .18s ease, background .18s ease;
}
.kanjiitem:hover{
  transform: translateY(-1px);
  border-color: hsla(var(--themeHue), 90%, 60%, .55);
  background: rgba(255,255,255,.13);
}
.kanjiitem .k{ font-size:28px; font-weight:900; color: var(--accent2); }
.kanjiitem .lvl{ margin-top:6px; font-size:11px; color: var(--muted); }
.kanjiitem .lvl b{ color: var(--text); }

.strokeBox{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.16);
  border-radius:16px;
  overflow:hidden;
  background: rgba(255,255,255,.07);
}
.strokeHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.12);
}
.strokeHead .t{ font-size:13px; color: var(--muted); }
.strokeBody{ padding:12px; }
.strokeBody svg{ width:100%; height:auto; display:block; }
.strokeNote{ color: var(--muted2); font-size:12px; margin-top:8px; }

.bigKanji{
  font-size:86px;
  font-weight:900;
  letter-spacing:2px;
  text-align:center;
  color: var(--accent2);
  line-height:1.0;
  margin: 8px 0 6px;
}

hr.sep{ border:none; border-top:1px solid rgba(255,255,255,.10); margin:14px 0; }

.small{ color: var(--muted); font-size:13px; }
.small b{ color: var(--text); }

.footer{ text-align:center; padding:40px 0 0; color: var(--muted2); font-size:12px; }

.mcGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
@media (max-width: 820px){ .mcGrid{ grid-template-columns:1fr; } }

.mcBox{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.07);
}
.mcBox h3{ margin:0 0 8px; font-size:13px; color: var(--muted); letter-spacing:.6px; }

.choiceList{ display:grid; gap:8px; }
.choiceBtn{
  text-align:left;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.26);
  background: rgba(255,255,255,.14);
  color: rgba(255,255,255,.98);
  cursor:pointer;
  font-weight:900;
  transition: transform .08s ease, border-color .18s ease, background .18s ease;
}
.choiceBtn:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.18);
  border-color: hsla(var(--themeHue), 90%, 60%, .55);
}
.choiceBtn.correct{ border-color: rgba(52,211,153,.85); background: rgba(52,211,153,.22); }
.choiceBtn.wrong{ border-color: rgba(251,113,133,.85); background: rgba(251,113,133,.20); }
.choiceBtn:disabled{ opacity:.96; cursor:not-allowed; }

.timerBarWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.08);
  overflow:hidden;
  margin-top:10px;
}
.timerBar{
  height:100%;
  width:100%;
  background: linear-gradient(90deg,
    hsla(var(--themeHue), 90%, 60%, .90),
    hsla(calc(var(--themeHue) - 25), 90%, 60%, .85),
    hsla(calc(var(--themeHue) + 55), 90%, 62%, .75)
  );
  transition: width .12s linear, filter .65s ease;
}

.flash{ position: fixed; inset: 0; pointer-events: none; opacity: 0; z-index: 999; }
.flash.good{ background: radial-gradient(circle at 50% 35%, rgba(52,211,153,.24), transparent 62%); }
.flash.bad{  background: radial-gradient(circle at 50% 35%, rgba(251,113,133,.24), transparent 62%); }
.flash.on{ animation: flash .55s ease-out; }
@keyframes flash{ 0%{ opacity:0; } 20%{ opacity:1; } 100%{ opacity:0; } }

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: rgba(238,242,255,.90);
  font-size:12px;
  font-weight:900;
  user-select:none;
}
.toggle input{
  width:16px;
  height:16px;
  accent-color: hsl(var(--themeHue) 90% 60%);
}

/* =========================================================
   PORTAL / ENTRADA ‚Äî IMERSIVO
========================================================= */
#app.appHidden{ display:none; }

.jpGate{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.jp-bg{
  position:absolute;
  inset:-40px;
  background:
    radial-gradient(1100px 700px at 18% 12%, rgba(130,90,255,.26), transparent 58%),
    radial-gradient(900px 650px at 84% 22%, rgba(0,255,200,.16), transparent 60%),
    radial-gradient(1000px 700px at 40% 88%, rgba(255,90,130,.16), transparent 58%),
    linear-gradient(180deg, rgba(8,10,14,.94), rgba(10,14,20,.98));
  transform: scale(1.05);
  filter: saturate(1.05);
}

.jp-pattern{
  position:absolute;
  inset:0;
  opacity:.16;
  mix-blend-mode: screen;
  background:
    radial-gradient(circle at 0 0, rgba(255,255,255,.20) 0 2px, transparent 2px 18px) 0 0/38px 38px,
    radial-gradient(circle at 19px 19px, rgba(255,255,255,.14) 0 2px, transparent 2px 18px) 0 0/38px 38px,
    radial-gradient(circle at 0 0, rgba(120,90,255,.18) 0 1px, transparent 1px 22px) 0 0/44px 44px;
  filter: blur(.2px);
}

/* ===== ÁÑ°Â∏∏ (MAIS VIS√çVEL) ===== */
.mujo{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-52%);
  font-weight: 1000;
  letter-spacing: 12px;
  font-size: clamp(180px, 24vw, 360px);
  line-height: 1;
  opacity: .34;
  z-index: 1;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,.95),
    rgba(160,240,255,.70),
    rgba(210,170,255,.78),
    rgba(255,90,130,.55)
  );
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;

  -webkit-text-stroke: 1.2px rgba(255,255,255,.22);

  text-shadow:
    0 0 18px rgba(255,255,255,.10),
    0 0 48px rgba(160,240,255,.16),
    0 0 110px rgba(0,255,200,.10),
    0 0 160px rgba(255,90,130,.10);

  filter: drop-shadow(0 0 30px rgba(0,0,0,.60));
  animation: mujoBreath 6.8s ease-in-out infinite;
}
.mujo::before,
.mujo::after{
  content: "ÁÑ°Â∏∏";
  position:absolute;
  inset:0;
  opacity:.55;
  pointer-events:none;
}
.mujo::before{
  transform: translate(2px, -1px);
  color: rgba(0,255,200,.18);
  filter: blur(.3px);
}
.mujo::after{
  transform: translate(-2px, 1px);
  color: rgba(255,90,130,.18);
  filter: blur(.3px);
}
@keyframes mujoBreath{
  0%,100%{ transform: translate(-50%,-52%) scale(1.00); opacity:.30; }
  50%{ transform: translate(-50%,-53%) scale(1.03); opacity:.40; }
}

/* ===== TORII (mais japon√™s, mais ‚Äújinja‚Äù) ===== */
.jp-torii{
  position:absolute;
  left:50%;
  top:50%;
  width:min(1040px, 98vw);
  height:min(660px, 82vh);
  transform: translate(-50%,-54%);
  opacity:.78;
  pointer-events:none;
  z-index:2;
  animation: toriiFloat 5.6s ease-in-out infinite;
}
.jp-torii svg{
  width:100%;
  height:100%;
  display:block;
  filter: drop-shadow(0 0 34px rgba(0,0,0,.55));
}
@keyframes toriiFloat{
  0%,100%{ transform: translate(-50%,-54%) scale(1.01); opacity:.72; }
  50%{ transform: translate(-50%,-55.2%) scale(1.02); opacity:.84; }
}

.shoji{
  position:absolute;
  top:0; bottom:0;
  width:50%;
  background:
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 2px, transparent 2px 60px),
    repeating-linear-gradient(0deg, rgba(255,255,255,.08) 0 2px, transparent 2px 58px);
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 40px 140px rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity:.95;
  z-index:3;
}
.shoji.left{ left:0; border-right:1px solid rgba(255,255,255,.16); }
.shoji.right{ right:0; border-left:1px solid rgba(255,255,255,.16); }
.shoji::after{
  content:"";
  position:absolute;
  inset:0;
  background: radial-gradient(900px 700px at 60% 30%, rgba(120,90,255,.14), transparent 55%);
  opacity:.9;
}

.jp-card{
  position:relative;
  z-index:5;
  width:min(720px, 92vw);
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  box-shadow: 0 24px 90px rgba(0,0,0,.70);
  padding: 26px 22px;
  text-align:center;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  animation: jpIn 1.15s ease both;
}
@keyframes jpIn{
  from{ opacity:0; transform: translateY(18px) scale(.975); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

.jp-kicker{
  font-weight:1000;
  letter-spacing: 3px;
  font-size: 12px;
  color: rgba(238,242,255,.72);
  text-transform: uppercase;
}

.jp-title{
  margin-top: 8px;
  font-size: 34px;
  font-weight: 1000;
  letter-spacing: 2px;
  background: linear-gradient(90deg, rgba(255,255,255,.92), rgba(160,240,255,.88), rgba(210,170,255,.90));
  -webkit-background-clip:text;
  background-clip:text;
  color: transparent;
  text-shadow: 0 0 22px rgba(160,240,255,.18);
}

.jp-glow{
  display:inline-block;
  margin-left: 8px;
  color: rgba(255,255,255,.75);
  text-shadow: 0 0 20px rgba(0,255,200,.18);
  animation: star 1.6s ease-in-out infinite;
}
@keyframes star{
  0%,100%{ transform: translateY(0) rotate(0deg); opacity:.8; }
  50%{ transform: translateY(-3px) rotate(10deg); opacity:1; }
}

.jp-sub{
  margin-top: 10px;
  font-size: 15px;
  color: rgba(238,242,255,.82);
}
.jp-sub b{
  color: rgba(255,255,255,.96);
  text-shadow: 0 0 18px rgba(160,240,255,.20);
}

.jp-line{
  width: min(520px, 86%);
  height: 1px;
  margin: 18px auto 16px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
}

.jp-glitch{
  position:relative;
  display:inline-block;
  font-weight:1000;
}
.jp-glitch::before,
.jp-glitch::after{
  content: attr(data-text);
  position:absolute;
  left:0;
  top:0;
  opacity:.32;
  pointer-events:none;
}
.jp-glitch::before{
  transform: translate(1px,0);
  color: rgba(0,255,200,.55);
  animation: jpGlitch 1.9s infinite linear alternate-reverse;
}
.jp-glitch::after{
  transform: translate(-1px,0);
  color: rgba(255,90,130,.55);
  animation: jpGlitch 2.1s infinite linear alternate;
}
@keyframes jpGlitch{
  0%{ clip-path: inset(0 0 90% 0); }
  20%{ clip-path: inset(10% 0 55% 0); }
  40%{ clip-path: inset(35% 0 30% 0); }
  60%{ clip-path: inset(55% 0 15% 0); }
  80%{ clip-path: inset(75% 0 8% 0); }
  100%{ clip-path: inset(90% 0 0 0); }
}

.jp-btn{
  position:relative;
  border:none;
  cursor:pointer;
  padding: 14px 18px;
  border-radius: 18px;
  font-weight: 1000;
  letter-spacing: .6px;
  color: rgba(255,255,255,.96);
  background: linear-gradient(90deg, rgba(120,90,255,.56), rgba(0,255,200,.26), rgba(255,90,130,.34));
  box-shadow: 0 18px 55px rgba(0,0,0,.60);
  min-width: 180px;
}
.jp-btn:hover{ filter: brightness(1.12); }
.jp-btn:active{ transform: translateY(1px); }
.jp-btn:disabled{ opacity:.7; cursor:not-allowed; }
.jp-btn-main{ display:block; font-size:16px; }
.jp-btn-sub{ display:block; font-size:11px; opacity:.78; margin-top:2px; }

.jp-btn-glow{
  position:absolute;
  inset:-2px;
  border-radius: 20px;
  background: radial-gradient(circle at 20% 30%, rgba(255,255,255,.40), transparent 55%);
  opacity:.35;
  pointer-events:none;
  animation: glowPulse 1.8s ease-in-out infinite;
}
@keyframes glowPulse{
  0%,100%{ opacity:.25; }
  50%{ opacity:.55; }
}

.jp-note{
  margin-top: 12px;
  font-size: 12px;
  color: rgba(238,242,255,.60);
}

.petals{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:4;
}
.petal{
  position:absolute;
  top:-12%;
  width: 16px;
  height: 12px;
  background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.55), rgba(255,150,190,.65) 35%, rgba(255,90,130,.40) 70%, transparent 72%);
  border-radius: 14px 14px 14px 2px;
  filter: blur(.2px);
  opacity:.75;
  animation: fall var(--dur) linear var(--delay) infinite;
}
@keyframes fall{
  0%{
    transform: translate3d(var(--x), -12vh, 0) rotate(0deg);
    opacity: 0;
  }
  8%{ opacity: .85; }
  100%{
    transform: translate3d(calc(var(--x) + var(--drift)), 112vh, 0) rotate(360deg);
    opacity: 0;
  }
}

.jp-fx{
  position:absolute;
  inset:-40px;
  pointer-events:none;
  opacity:0;
  background:
    radial-gradient(900px 550px at 50% 45%, rgba(255,255,255,.16), transparent 60%),
    radial-gradient(900px 650px at 50% 55%, rgba(120,90,255,.20), transparent 62%),
    radial-gradient(900px 650px at 55% 50%, rgba(0,255,200,.16), transparent 62%);
  transform: scale(1);
  z-index:6;
}

/* sa√≠da mais devagar */
.jpGate.leaving .shoji.left{ animation: shojiLeft 1.55s cubic-bezier(.2,.9,.2,1) forwards; }
.jpGate.leaving .shoji.right{ animation: shojiRight 1.55s cubic-bezier(.2,.9,.2,1) forwards; }
@keyframes shojiLeft{ to{ transform: translateX(-105%); opacity:.98; } }
@keyframes shojiRight{ to{ transform: translateX(105%); opacity:.98; } }

.jpGate.leaving .jp-card{ animation: cardOut 1.05s ease forwards; }
@keyframes cardOut{ to{ opacity:0; transform: translateY(12px) scale(.985); } }

.jpGate.leaving .jp-bg{ animation: bgOut 1.65s ease forwards; }
@keyframes bgOut{ to{ transform: scale(1.12); opacity:0; } }

.jpGate.leaving .jp-fx{
  opacity:1;
  animation: fx 1.65s ease forwards;
}
@keyframes fx{
  0%{ transform: scale(1); opacity:0; }
  30%{ transform: scale(1.10); opacity:1; }
  100%{ transform: scale(1.38); opacity:0; }
}
</style>
</head>

<body>
<div id="flash" class="flash"></div>

<!-- ====== PORTAL / TELA DE ENTRADA ====== -->
<section id="gate" class="jpGate">
  <div class="jp-bg"></div>
  <div class="jp-pattern"></div>

  <!-- ÁÑ°Â∏∏ gigante -->
  <div class="mujo" aria-hidden="true">ÁÑ°Â∏∏</div>

  <!-- TORII (mais japon√™s) -->
  <div class="jp-torii" aria-hidden="true">
    <svg viewBox="0 0 1400 800" role="presentation">
      <defs>
        <linearGradient id="verm" x1="0" x2="1">
          <stop offset="0%" stop-color="rgba(255,90,90,.92)"/>
          <stop offset="35%" stop-color="rgba(255,70,120,.88)"/>
          <stop offset="70%" stop-color="rgba(190,90,255,.70)"/>
          <stop offset="100%" stop-color="rgba(255,255,255,.10)"/>
        </linearGradient>

        <filter id="patina" x="-30%" y="-30%" width="160%" height="160%">
          <feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="2" seed="9" result="n"/>
          <feColorMatrix in="n" type="matrix"
            values="1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 .10 0" result="a"/>
          <feComposite in="a" in2="SourceGraphic" operator="in" result="m"/>
          <feMerge>
            <feMergeNode in="m"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>

        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="8" result="b"/>
          <feColorMatrix in="b" type="matrix"
            values="1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 .45 0" result="g"/>
          <feMerge>
            <feMergeNode in="g"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <path d="M110 190
               C 340 88, 1060 88, 1290 190
               C 1060 165, 340 165, 110 190 Z"
            fill="url(#verm)" filter="url(#glow)"></path>

      <path d="M210 270
               C 420 200, 980 200, 1190 270
               C 980 252, 420 252, 210 270 Z"
            fill="rgba(255,255,255,.12)"></path>

      <path d="M320 360
               C 460 318, 940 318, 1080 360
               C 940 382, 460 382, 320 360 Z"
            fill="rgba(0,255,200,.10)"></path>

      <path d="M410 300
               C 395 420, 380 610, 396 728
               C 408 760, 470 760, 488 728
               C 505 610, 488 420, 474 300 Z"
            fill="url(#verm)" filter="url(#patina)"></path>

      <path d="M926 300
               C 912 420, 898 610, 914 728
               C 926 760, 988 760, 1006 728
               C 1022 610, 1006 420, 992 300 Z"
            fill="url(#verm)" filter="url(#patina)"></path>

      <path d="M684 330
               C 675 440, 668 612, 674 728
               C 683 754, 717 754, 726 728
               C 733 612, 726 440, 716 330 Z"
            fill="rgba(255,255,255,.07)"></path>

      <path d="M372 728 C 420 696, 496 696, 544 728
               C 496 760, 420 760, 372 728 Z"
            fill="rgba(255,255,255,.10)"></path>

      <path d="M870 728 C 918 696, 994 696, 1042 728
               C 994 760, 918 760, 870 728 Z"
            fill="rgba(255,255,255,.10)"></path>

      <path d="M658 275 C 690 255, 720 255, 752 275
               C 720 292, 690 292, 658 275 Z"
            fill="rgba(255,255,255,.08)"></path>
    </svg>
  </div>

  <div class="shoji left"></div>
  <div class="shoji right"></div>

  <div id="petals" class="petals"></div>

  <div class="jp-card">
    <div class="jp-kicker">„Çà„ÅÜ„Åì„Åù</div>

    <div class="jp-title">
      yooo <span class="jp-glow">‚ú¶</span>
    </div>

    <div class="jp-sub">
      S√∫ditos do <b>„É¥„Ç°„É≥„Éë„Ç§„Ç¢Êßò</b> ‚Äî
      <span class="jp-glitch" data-text="„Çø„Éê„Ç≥">„Çø„Éê„Ç≥</span>
    </div>

    <div class="jp-line"></div>

    <button id="enterBtn" class="jp-btn">
      <span class="jp-btn-main">ÂÖ•„Çã</span>
      <span class="jp-btn-sub">Entrar</span>
      <span class="jp-btn-glow"></span>
    </button>

    <div class="jp-note">Enter„Ç≠„Éº„Åß„ÇÇOK</div>
  </div>

  <div id="gateFx" class="jp-fx"></div>
</section>

<!-- ====== APP (site real) ====== -->
<div id="app" class="appHidden">

<header>
  <div class="topbar">
    <div class="brand">
      <div class="t">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ</div>
      <div class="s">Kanji <b>N5 + N4</b></div>
    </div>

    <nav>
      <div class="tabbtn active" id="tab-kanji">üà∂ Kanji</div>
      <div class="tabbtn" id="tab-quiz">üéÆ Jogo</div>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ====================== KANJI ====================== -->
  <section id="kanji" class="section active">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Kanji ‚Äî Lista (N5 + N4)</h2>
            <p class="hint" id="kanjiCountHint">‚Äî</p>
          </div>

          <div class="row">
            <div class="small">Filtro</div>
            <select id="levelFilter">
              <option value="ALL" selected>ALL (N5+N4)</option>
              <option value="N5">Somente N5</option>
              <option value="N4">Somente N4</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="small">Pesquisar</div>
          <input id="kanjiSearch" type="text" placeholder="Ex: Â≠¶ / „Åå„Åè / „Åæ„Å™ / casa / mundo" />
          <div class="btn warn" id="clearSearch">Limpar</div>
        </div>

        <div class="kanjigrid" id="kanjigrid"></div>
      </div>

      <div class="panel" id="detailPanel">
        <h2>Detalhe</h2>
        <p class="hint">Selecione um kanji na lista.</p>

        <div id="kanjiDetail" class="card" style="display:none;">
          <div class="jp" id="kdKanji"></div>
          <div class="hira" id="kdReadings"></div>
          <div class="mean" id="kdMean"></div>
          <div class="badges" id="kdBadges"></div>

          <div class="strokeBox" id="kdStrokeBox">
            <div class="strokeHead">
              <div class="t">Ordem dos tra√ßos</div>
              <div class="row">
                <div class="btn primary" id="kdReplay">Repetir</div>
                <select id="kdSpeed" title="Velocidade">
                  <option value="0.7">R√°pido</option>
                  <option value="1" selected>Normal</option>
                  <option value="1.35">Lento</option>
                </select>
              </div>
            </div>
            <div class="strokeBody" id="kdStroke"></div>
            <div class="strokeNote">Fonte: KanjiVG (SVG).</div>
          </div>

          <hr class="sep">
          <div class="row">
            <div class="btn good" id="kdTrain">Treinar no Jogo</div>
          </div>
        </div>

        <div id="kanjiDetailEmpty" class="card">
          <div class="mean" style="color:var(--muted);">Clique em um kanji para ver detalhes aqui.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== QUIZ ====================== -->
  <section id="quiz" class="section">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Jogo</h2>
            <p class="hint"></p>
          </div>

          <div class="row">
            <label class="toggle" title="Repete mais os que voc√™ erra (peso no sorteio)">
              <input type="checkbox" id="quizSmart" checked />
              modo inteligente
            </label>
            <label class="toggle" title="Reinicia automaticamente a cada quest√£o">
              <input type="checkbox" id="quizAuto" checked />
              auto-run
            </label>

            <!-- ‚úÖ S√≥ aparece quando EXISTEM erros (fila de revis√£o) -->
            <span id="reviewToggleWrap" style="display:none;">
              <label class="toggle" title="Treino separado: s√≥ os kanjis que voc√™ errou (fila de revis√£o). Se n√£o houver erros, essa op√ß√£o some.">
                <input type="checkbox" id="quizReviewOnly" />
                revisar erros
              </label>
            </span>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end;">
            <div style="flex:1;">
              <div class="bigKanji" id="quizKanji">‰∏Ä</div>
              <div class="badges" style="justify-content:center;">
                <span class="badge" id="quizScore">Acertos: 0 ¬∑ Erros: 0 ¬∑ Streak: 0</span>
                <span class="badge" id="quizTimerText">‚è±Ô∏è 12s</span>
                <span class="badge tag" id="quizMoodText">Mood: ‚Äî</span>
                <span class="badge tag" id="quizReviewText">Revis√£o: 0</span>
              </div>
              <div class="timerBarWrap">
                <div class="timerBar" id="timerBar"></div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <div class="small">N√≠vel</div>
              <select id="quizLevel">
                <option value="ALL" selected>ALL</option>
                <option value="N5">N5</option>
                <option value="N4">N4</option>
              </select>

              <div class="small">Tempo</div>
              <select id="quizTime">
                <option value="8">8s</option>
                <option value="12" selected>12s</option>
                <option value="18">18s</option>
                <option value="25">25s</option>
              </select>

              <div class="btn good" id="quizStart">Start</div>
              <div class="btn warn" id="quizPause">Pausar</div>
              <div class="btn primary" id="quizNext">Pr√≥ximo</div>
              <div class="btn danger" id="quizReset">Zerar sess√£o</div>
            </div>
          </div>

          <hr class="sep">

          <div class="mcGrid">
            <div class="mcBox">
              <h3>Leitura</h3>
              <div class="choiceList" id="readingChoices"></div>
            </div>

            <div class="mcBox">
              <h3>Significado</h3>
              <div class="choiceList" id="meaningChoices"></div>
            </div>
          </div>

          <!-- FEEDBACK + 3 PALAVRAS -->
          <div id="quizFeedback" class="card" style="display:none;">
            <div class="mean" id="quizFeedbackTitle"></div>
            <div class="hira" id="quizFeedbackDetail"></div>

            <hr class="sep">

            <div class="mean">üìö 3 palavras com este kanji (Jisho ‚Üí PT-BR)</div>
            <div class="small" id="quizExamples">‚Äî</div>
            <div class="small" style="margin-top:6px; opacity:.9;">
              *Fonte: Jisho (dados) + tradu√ß√£o autom√°tica para PT-BR.
            </div>

            <div class="strokeBox" style="margin-top:12px;">
              <div class="strokeHead">
                <div class="t">Ordem dos tra√ßos</div>
                <div class="row">
                  <div class="btn primary" id="quizReplay">Repetir</div>
                  <select id="quizSpeed" title="Velocidade">
                    <option value="0.7">R√°pido</option>
                    <option value="1" selected>Normal</option>
                    <option value="1.35">Lento</option>
                  </select>
                </div>
              </div>
              <div class="strokeBody" id="quizStroke"></div>
              <div class="strokeNote">Fonte: KanjiVG.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Ranking + Estat√≠sticas</h2>
        <p class="hint">Salvo no navegador.</p>

        <div class="card">
          <div class="mean">üèÜ Melhores marcas</div>
          <div class="small" id="bestStats">‚Äî</div>

          <hr class="sep">
          <div class="mean">üìä Kanji mais errados</div>
          <div class="small" id="worstKanjis">‚Äî</div>

          <hr class="sep">
          <div class="row">
            <div class="btn danger" id="resetHistory">Resetar hist√≥rico</div>
            <div class="btn good" id="goKanji">Voltar ao Kanji</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ¬© 2025</div>
</div>

<script>
/* =========================
   THEME CYCLE (a cada 5s)
========================= */
(function(){
  const hues = [195, 230, 265, 305, 20, 55, 110, 155];
  let i = Math.floor(Math.random() * hues.length);
  document.documentElement.style.setProperty("--themeHue", String(hues[i]));

  setInterval(()=>{
    i = (i + 1) % hues.length;
    document.documentElement.style.setProperty("--themeHue", String(hues[i]));
  }, 5000);
})();

/* =========================
   LISTAS DE N√çVEL
========================= */
const N5_LIST = [
  "‰∏Ä","‰∏É","‰∏á","‰∏â","‰∏ä","‰∏ã","‰∏≠","‰πù","‰∫å","‰∫î","‰∫∫","‰ªä","‰ºë","‰Ωï","ÂÖà","ÂÖ•","ÂÖ´","ÂÖ≠","ÂÜÜ","Âá∫","ÂàÜ","Ââç","Âåó","ÂçÅ","ÂçÉ","Âçà","Âçä","Âçó","Âèã","Âè≥","Âêç","Âõõ","ÂõΩ","Âúü","Â§ñ","Â§ß","Â§©","Â•≥","Â≠ê","Â≠¶","Â∞è","Â±±","Â∑ù","Â∑¶","Âπ¥","Âæå","Êó•","ÊôÇ","Êõ∏","Êúà","Êú®","Êú¨","Êù•","Êù±","Ê†°","ÊØç","ÊØé","Ê∞ó","Ê∞¥","ÁÅ´","Áà∂","Áîü","Áî∑","ÁôΩ","Áôæ","ËÅû","Ë°å","Ë•ø","Ë¶ã","Ë©±","Ë™û","Ë™≠","Ëªä","Èáë","Èï∑","Èñì","Èõ®","Èõª","È£ü","È´ò"
];
const N4_LIST = [
  "‰∏ç","‰∏ñ","‰∏ª","‰∫ã","‰∫¨","‰ªï","‰ª£","‰ª•","‰ºö","‰Ωè","‰Ωì","‰Ωú","‰Ωø","ÂÄü","ÂÖÉ","ÂÖÑ","ÂÖ¨","ÂÜô","ÂÜ¨","Âàá","Âà•","Âäõ","Âãâ","Âãï","Âåª","Âéª","Âè£","Âè§","Âè∞","Âêå","Âë≥","ÂìÅ","Âì°","Âïè","Âõ≥","Âú∞","Â†Ç","Â†¥","Â£≤","Â§è","Â§ï","Â§ö","Â§ú","Â¶π","Âßâ","Âßã","Â≠ó","ÂÆâ","ÂÆ§","ÂÆ∂","Â∞ë","Â±ã","Â∑•","Â∏∞","Â∫É","Â∫ó","Â∫¶","Âª∫","Âºü","Âº∑","ÂæÖ","ÂøÉ","ÊÄù","ÊÄ•","ÊÇ™","ÊÑè","Êâã","ÊåÅ","Êïô","Êñá","Êñô","Êñ∞","Êñπ","ÊóÖ","Êóè","Êó©","Êòé","Êò†","Êò•","Êòº","Êõú","Êúâ","Êúç","Êúù","Ê•≠","Ê•Ω","Ê≠å","Ê≠¢","Ê≠£","Ê≠©","Ê≠ª","Ê≥®","Ê¥ã","Êµ∑","Êº¢","Áâõ","Áâ©","Áâπ","Áä¨","ÁêÜ","Áî®","Áî∞","Áî∫","Áîª","Áïå","ÁóÖ","Áô∫","ÁöÑ","ÁõÆ","Áúü","ÁùÄ","Áü•","Á†î","Á§æ","ÁßÅ","Áßã","Á©∂","Á©∫","Á´ã","Á≠î","Á¥ô","ÁµÇ","Áøí","ËÄÉ","ËÄÖ","ËÇâ","Ëá™","Ëâ≤","Ëä±","Ëã±","Ëå∂","Ë¶™","Ë®Ä","Ë®à","Ë©¶","Ë≤∑","Ë≤∏","Ë≥™","Ëµ§","Ëµ∞","Ëµ∑","Ë∂≥","Ëª¢","Ëøë","ÈÄÅ","ÈÄö","ÈÄ±","ÈÅã","ÈÅì","Èáç","Èáé","ÈäÄ","Èñã","Èô¢","ÈõÜ","Èùí","Èü≥","È°å","È¢®","È£Ø","È£≤","È§®","ÈßÖ","È®ì","È≠ö","È≥•","Èªí"
];
const N5_SET = new Set(N5_LIST);
const N4_SET = new Set(N4_LIST);

/* =========================
   KANJI_INFO (PT-BR)
========================= */
const KANJI_INFO = {
  "‰∏Ä":{readings:["„ÅÑ„Å°","„Å≤„Å®"], meaning:"um"},
  "‰∏É":{readings:["„Åó„Å°","„Å™„Å™"], meaning:"sete"},
  "‰∏á":{readings:["„Åæ„Çì"], meaning:"dez mil"},
  "‰∏â":{readings:["„Åï„Çì","„Åø„Å£"], meaning:"tr√™s"},
  "‰∏ä":{readings:["„ÅÜ„Åà","„Åò„Çá„ÅÜ"], meaning:"cima / sobre"},
  "‰∏ã":{readings:["„Åó„Åü","„Åã"], meaning:"baixo / descer"},
  "‰∏≠":{readings:["„Å™„Åã","„Å°„ÇÖ„ÅÜ"], meaning:"meio / dentro"},
  "‰πù":{readings:["„Åç„ÇÖ„ÅÜ","„Åì„Åì„ÅÆ"], meaning:"nove"},
  "‰∫å":{readings:["„Å´","„Åµ„Åü"], meaning:"dois"},
  "‰∫î":{readings:["„Åî","„ÅÑ„Å§"], meaning:"cinco"},
  "‰∫∫":{readings:["„Å≤„Å®","„Å´„Çì"], meaning:"pessoa"},
  "‰ªä":{readings:["„ÅÑ„Åæ","„Åì„Çì"], meaning:"agora"},
  "‰ºë":{readings:["„ÇÑ„Åô","„Åç„ÇÖ„ÅÜ"], meaning:"descansar"},
  "‰Ωï":{readings:["„Å™„Å´","„Å™„Çì"], meaning:"o que"},
  "ÂÖà":{readings:["„Åï„Åç","„Åõ„Çì"], meaning:"antes / anterior"},
  "ÂÖ•":{readings:["„ÅÑ","„Å´„ÇÖ„ÅÜ"], meaning:"entrar"},
  "ÂÖ´":{readings:["„ÅØ„Å°","„ÇÑ"], meaning:"oito"},
  "ÂÖ≠":{readings:["„Çç„Åè","„ÇÄ"], meaning:"seis"},
  "ÂÜÜ":{readings:["„Åà„Çì"], meaning:"iene / c√≠rculo"},
  "Âá∫":{readings:["„Åß","„Åó„ÇÖ„Å§"], meaning:"sair / aparecer"},
  "ÂàÜ":{readings:["„Åµ„Çì","„Å∂„Çì","„Çè"], meaning:"minuto / parte"},
  "Ââç":{readings:["„Åæ„Åà","„Åú„Çì"], meaning:"antes / frente"},
  "Âåó":{readings:["„Åç„Åü","„Åª„Åè"], meaning:"norte"},
  "ÂçÅ":{readings:["„Åò„ÇÖ„ÅÜ","„Å®„Åä"], meaning:"dez"},
  "ÂçÉ":{readings:["„Åõ„Çì"], meaning:"mil"},
  "Âçà":{readings:["„Åî"], meaning:"meio-dia (ÂçàÂâç/ÂçàÂæå)"},
  "Âçä":{readings:["„ÅØ„Çì"], meaning:"metade"},
  "Âçó":{readings:["„Åø„Å™„Åø","„Å™„Çì"], meaning:"sul"},
  "Âèã":{readings:["„Å®„ÇÇ","„ÇÜ„ÅÜ"], meaning:"amigo"},
  "Âè≥":{readings:["„Åø„Åé","„ÅÜ"], meaning:"direita"},
  "Âêç":{readings:["„Å™","„ÇÅ„ÅÑ"], meaning:"nome"},
  "Âõõ":{readings:["„Çà„Çì","„Åó"], meaning:"quatro"},
  "ÂõΩ":{readings:["„Åè„Å´","„Åì„Åè"], meaning:"pa√≠s"},
  "Âúü":{readings:["„Å§„Å°","„Å©"], meaning:"terra / solo"},
  "Â§ñ":{readings:["„Åù„Å®","„Åå„ÅÑ"], meaning:"fora"},
  "Â§ß":{readings:["„Åä„Åä","„Å†„ÅÑ"], meaning:"grande"},
  "Â§©":{readings:["„Å¶„Çì","„ÅÇ„Åæ"], meaning:"c√©u"},
  "Â•≥":{readings:["„Åä„Çì„Å™","„Åò„Çá"], meaning:"mulher"},
  "Â≠ê":{readings:["„Åì","„Åó"], meaning:"crian√ßa"},
  "Â≠¶":{readings:["„Åæ„Å™","„Åå„Åè"], meaning:"estudar / estudo"},
  "Â∞è":{readings:["„Å°„ÅÑ","„Åó„Çá„ÅÜ"], meaning:"pequeno"},
  "Â±±":{readings:["„ÇÑ„Åæ","„Åï„Çì"], meaning:"montanha"},
  "Â∑ù":{readings:["„Åã„Çè","„Åõ„Çì"], meaning:"rio"},
  "Â∑¶":{readings:["„Å≤„Å†„Çä","„Åï"], meaning:"esquerda"},
  "Âπ¥":{readings:["„Å®„Åó","„Å≠„Çì"], meaning:"ano"},
  "Âæå":{readings:["„ÅÇ„Å®","„Åî"], meaning:"depois / atr√°s"},
  "Êó•":{readings:["„Å≤","„Å´„Å°"], meaning:"dia / sol"},
  "ÊôÇ":{readings:["„Å®„Åç","„Åò"], meaning:"tempo / hora"},
  "Êõ∏":{readings:["„Åã","„Åó„Çá"], meaning:"escrever"},
  "Êúà":{readings:["„Å§„Åç","„Åí„Å§"], meaning:"m√™s / lua"},
  "Êú®":{readings:["„Åç","„ÇÇ„Åè"], meaning:"√°rvore / madeira"},
  "Êú¨":{readings:["„Åª„Çì","„ÇÇ„Å®"], meaning:"livro / origem"},
  "Êù•":{readings:["„Åè","„Çâ„ÅÑ"], meaning:"vir"},
  "Êù±":{readings:["„Å≤„Åå„Åó","„Å®„ÅÜ"], meaning:"leste"},
  "Ê†°":{readings:["„Åì„ÅÜ"], meaning:"escola"},
  "ÊØç":{readings:["„ÅØ„ÅØ","„Åº"], meaning:"m√£e"},
  "ÊØé":{readings:["„Åæ„ÅÑ"], meaning:"cada / todo"},
  "Ê∞ó":{readings:["„Åç"], meaning:"energia / humor"},
  "Ê∞¥":{readings:["„Åø„Åö","„Åô„ÅÑ"], meaning:"√°gua"},
  "ÁÅ´":{readings:["„Å≤","„Åã"], meaning:"fogo"},
  "Áà∂":{readings:["„Å°„Å°","„Åµ"], meaning:"pai"},
  "Áîü":{readings:["„ÅÑ","„Åõ„ÅÑ","„Å™„Åæ"], meaning:"vida / nascer / cru"},
  "Áî∑":{readings:["„Åä„Å®„Åì","„Å†„Çì"], meaning:"homem"},
  "ÁôΩ":{readings:["„Åó„Çç","„ÅØ„Åè"], meaning:"branco"},
  "Áôæ":{readings:["„Å≤„ÇÉ„Åè"], meaning:"cem"},
  "ËÅû":{readings:["„Åç","„Å∂„Çì"], meaning:"ouvir / perguntar"},
  "Ë°å":{readings:["„ÅÑ","„Åì„ÅÜ"], meaning:"ir / fazer"},
  "Ë•ø":{readings:["„Å´„Åó","„Åõ„ÅÑ"], meaning:"oeste"},
  "Ë¶ã":{readings:["„Åø","„Åë„Çì"], meaning:"ver / olhar"},
  "Ë©±":{readings:["„ÅØ„Å™","„Çè"], meaning:"falar / conversa"},
  "Ë™û":{readings:["„Åî"], meaning:"idioma / palavra"},
  "Ë™≠":{readings:["„Çà","„Å©„Åè"], meaning:"ler"},
  "Ëªä":{readings:["„Åè„Çã„Åæ","„Åó„ÇÉ"], meaning:"carro / ve√≠culo"},
  "Èáë":{readings:["„Åã„Å≠","„Åç„Çì"], meaning:"dinheiro / ouro"},
  "Èï∑":{readings:["„Å™„Åå","„Å°„Çá„ÅÜ"], meaning:"longo / chefe"},
  "Èñì":{readings:["„ÅÇ„ÅÑ„Å†","„Åã„Çì"], meaning:"intervalo / entre"},
  "Èõ®":{readings:["„ÅÇ„ÇÅ","„ÅÜ"], meaning:"chuva"},
  "Èõª":{readings:["„Åß„Çì"], meaning:"eletricidade"},
  "È£ü":{readings:["„Åü","„Åó„Çá„Åè"], meaning:"comer / comida"},
  "È´ò":{readings:["„Åü„Åã","„Åì„ÅÜ"], meaning:"alto / caro"},

  "‰∏ç":{readings:["„Åµ","„Å™„ÅÑ"], meaning:"n√£o / negativo"},
  "‰∏ñ":{readings:["„Åõ„ÅÑ","„Çà"], meaning:"mundo / sociedade"},
  "‰∏ª":{readings:["„Åó„ÇÖ","„Å¨„Åó"], meaning:"principal / dono"},
  "‰∫ã":{readings:["„Åì„Å®","„Åò"], meaning:"coisa / assunto"},
  "‰∫¨":{readings:["„Åç„Çá„ÅÜ","„Åë„ÅÑ"], meaning:"capital"},
  "‰ªï":{readings:["„Åó"], meaning:"servir / trabalho"},
  "‰ª£":{readings:["„Å†„ÅÑ","„Åü„ÅÑ","„Åã"], meaning:"substituir / era"},
  "‰ª•":{readings:["„ÅÑ"], meaning:"a partir de / por"},
  "‰ºö":{readings:["„Åã„ÅÑ","„ÅÇ"], meaning:"encontro / reuni√£o"},
  "‰Ωè":{readings:["„Åô","„Åò„ÇÖ„ÅÜ"], meaning:"morar"},
  "‰Ωì":{readings:["„Åã„Çâ„Å†","„Åü„ÅÑ"], meaning:"corpo"},
  "‰Ωú":{readings:["„Å§„Åè","„Åï„Åè"], meaning:"fazer / criar"},
  "‰Ωø":{readings:["„Å§„Åã","„Åó"], meaning:"usar"},
  "ÂÄü":{readings:["„Åã","„Åó„ÇÉ„Åè"], meaning:"pegar emprestado"},
  "ÂÖÉ":{readings:["„ÇÇ„Å®","„Åí„Çì"], meaning:"origem / ex-"},
  "ÂÖÑ":{readings:["„ÅÇ„Å´","„Åç„Çá„ÅÜ"], meaning:"irm√£o mais velho"},
  "ÂÖ¨":{readings:["„Åì„ÅÜ","„Åä„Åä„ÇÑ„Åë"], meaning:"p√∫blico"},
  "ÂÜô":{readings:["„ÅÜ„Å§","„Åó„ÇÉ"], meaning:"copiar / fotografar"},
  "ÂÜ¨":{readings:["„Åµ„ÇÜ","„Å®„ÅÜ"], meaning:"inverno"},
  "Âàá":{readings:["„Åç","„Åõ„Å§"], meaning:"cortar"},
  "Âà•":{readings:["„Åπ„Å§","„Çè„Åã"], meaning:"separar / diferente"},
  "Âäõ":{readings:["„Å°„Åã„Çâ","„Çä„Çá„Åè"], meaning:"for√ßa"},
  "Âãâ":{readings:["„Åπ„Çì"], meaning:"esfor√ßo (ÂãâÂº∑)"},
  "Âãï":{readings:["„ÅÜ„Åî","„Å©„ÅÜ"], meaning:"mover / movimento"},
  "Âåª":{readings:["„ÅÑ"], meaning:"medicina / m√©dico"},
  "Âéª":{readings:["„Åï","„Åç„Çá"], meaning:"passado / ir embora"},
  "Âè£":{readings:["„Åè„Å°","„Åì„ÅÜ"], meaning:"boca"},
  "Âè§":{readings:["„Åµ„Çã","„Åì"], meaning:"antigo"},
  "Âè∞":{readings:["„Å†„ÅÑ","„Åü„ÅÑ"], meaning:"base / suporte"},
  "Âêå":{readings:["„Åä„Å™","„Å©„ÅÜ"], meaning:"mesmo"},
  "Âë≥":{readings:["„ÅÇ„Åò","„Åø"], meaning:"sabor"},
  "ÂìÅ":{readings:["„Åó„Å™","„Å≤„Çì"], meaning:"produto / item"},
  "Âì°":{readings:["„ÅÑ„Çì"], meaning:"membro / funcion√°rio"},
  "Âïè":{readings:["„Å®","„ÇÇ„Çì"], meaning:"perguntar / pergunta"},
  "Âõ≥":{readings:["„Åö","„ÅØ„Åã"], meaning:"diagrama / plano"},
  "Âú∞":{readings:["„Å°","„Åò"], meaning:"terra / local"},
  "Â†Ç":{readings:["„Å©„ÅÜ"], meaning:"sal√£o / pr√©dio"},
  "Â†¥":{readings:["„Å∞","„Åò„Çá„ÅÜ"], meaning:"lugar"},
  "Â£≤":{readings:["„ÅÜ","„Å∞„ÅÑ"], meaning:"vender"},
  "Â§è":{readings:["„Å™„Å§","„Åã"], meaning:"ver√£o"},
  "Â§ï":{readings:["„ÇÜ„ÅÜ"], meaning:"tarde / entardecer"},
  "Â§ö":{readings:["„Åä„Åä","„Åü"], meaning:"muito"},
  "Â§ú":{readings:["„Çà„Çã","„ÇÑ"], meaning:"noite"},
  "Â¶π":{readings:["„ÅÑ„ÇÇ„ÅÜ„Å®"], meaning:"irm√£ mais nova"},
  "Âßâ":{readings:["„ÅÇ„Å≠"], meaning:"irm√£ mais velha"},
  "Âßã":{readings:["„ÅØ„Åò","„Åó"], meaning:"come√ßar"},
  "Â≠ó":{readings:["„Åò"], meaning:"caractere / letra"},
  "ÂÆâ":{readings:["„ÇÑ„Åô","„ÅÇ„Çì"], meaning:"barato / seguro"},
  "ÂÆ§":{readings:["„Åó„Å§"], meaning:"sala / quarto"},
  "ÂÆ∂":{readings:["„ÅÑ„Åà","„Åã"], meaning:"casa / fam√≠lia"},
  "Â∞ë":{readings:["„Åô„Åì","„Åó„Çá„ÅÜ"], meaning:"pouco"},
  "Â±ã":{readings:["„ÇÑ"], meaning:"loja / profiss√£o"},
  "Â∑•":{readings:["„Åì„ÅÜ","„Åè"], meaning:"trabalho / t√©cnica"},
  "Â∏∞":{readings:["„Åã„Åà","„Åç"], meaning:"voltar"},
  "Â∫É":{readings:["„Å≤„Çç","„Åì„ÅÜ"], meaning:"amplo / largo"},
  "Â∫ó":{readings:["„Åø„Åõ","„Å¶„Çì"], meaning:"loja"},
  "Â∫¶":{readings:["„Å©","„Åü„Å≥"], meaning:"vez / grau"},
  "Âª∫":{readings:["„Åü","„Åë„Çì"], meaning:"construir"},
  "Âºü":{readings:["„Åä„Å®„ÅÜ„Å®","„Å†„ÅÑ"], meaning:"irm√£o mais novo"},
  "Âº∑":{readings:["„Å§„Çà","„Åç„Çá„ÅÜ"], meaning:"forte"},
  "ÂæÖ":{readings:["„Åæ","„Åü„ÅÑ"], meaning:"esperar"},
  "ÂøÉ":{readings:["„Åì„Åì„Çç","„Åó„Çì"], meaning:"cora√ß√£o / mente"},
  "ÊÄù":{readings:["„Åä„ÇÇ","„Åó"], meaning:"pensar"},
  "ÊÄ•":{readings:["„ÅÑ„Åù","„Åç„ÇÖ„ÅÜ"], meaning:"urgente / r√°pido"},
  "ÊÇ™":{readings:["„Çè„Çã","„ÅÇ„Åè"], meaning:"ruim / mal"},
  "ÊÑè":{readings:["„ÅÑ"], meaning:"inten√ß√£o / ideia"},
  "Êâã":{readings:["„Å¶","„Åó„ÇÖ"], meaning:"m√£o"},
  "ÊåÅ":{readings:["„ÇÇ","„Åò"], meaning:"segurar / ter"},
  "Êïô":{readings:["„Åä„Åó","„Åç„Çá„ÅÜ"], meaning:"ensinar"},
  "Êñá":{readings:["„Å∂„Çì","„Åµ„Åø"], meaning:"texto / frase"},
  "Êñô":{readings:["„Çä„Çá„ÅÜ"], meaning:"taxa / material"},
  "Êñ∞":{readings:["„ÅÇ„Åü„Çâ","„Åó„Çì"], meaning:"novo"},
  "Êñπ":{readings:["„Åã„Åü","„Åª„ÅÜ"], meaning:"lado / maneira"},
  "ÊóÖ":{readings:["„Åü„Å≥","„Çä„Çá"], meaning:"viagem"},
  "Êóè":{readings:["„Åû„Åè"], meaning:"fam√≠lia / grupo"},
  "Êó©":{readings:["„ÅØ„ÇÑ","„Åù„ÅÜ"], meaning:"cedo / r√°pido"},
  "Êòé":{readings:["„ÅÇ„Åã","„ÇÅ„ÅÑ"], meaning:"claro / brilhante"},
  "Êò†":{readings:["„ÅÜ„Å§","„Åà„ÅÑ"], meaning:"refletir / projetar"},
  "Êò•":{readings:["„ÅØ„Çã","„Åó„ÇÖ„Çì"], meaning:"primavera"},
  "Êòº":{readings:["„Å≤„Çã"], meaning:"dia / meio-dia"},
  "Êõú":{readings:["„Çà„ÅÜ"], meaning:"dia da semana"},
  "Êúâ":{readings:["„ÅÇ","„ÇÜ„ÅÜ"], meaning:"existir / ter"},
  "Êúç":{readings:["„Åµ„Åè"], meaning:"roupa"},
  "Êúù":{readings:["„ÅÇ„Åï","„Å°„Çá„ÅÜ"], meaning:"manh√£"},
  "Ê•≠":{readings:["„Åé„Çá„ÅÜ","„Çè„Åñ"], meaning:"trabalho / atividade"},
  "Ê•Ω":{readings:["„Åü„ÅÆ","„Åå„Åè","„Çâ„Åè"], meaning:"divers√£o / conforto"},
  "Ê≠å":{readings:["„ÅÜ„Åü","„Åã"], meaning:"can√ß√£o / cantar"},
  "Ê≠¢":{readings:["„Å®","„Åó"], meaning:"parar"},
  "Ê≠£":{readings:["„Åü„Å†","„Åõ„ÅÑ"], meaning:"correto"},
  "Ê≠©":{readings:["„ÅÇ„Çã","„Åª"], meaning:"andar (a p√©)"},
  "Ê≠ª":{readings:["„Åó","„Åó„Å¨"], meaning:"morrer"},
  "Ê≥®":{readings:["„Åù„Åù","„Å°„ÇÖ„ÅÜ"], meaning:"despejar / aten√ß√£o"},
  "Ê¥ã":{readings:["„Çà„ÅÜ"], meaning:"ocidental"},
  "Êµ∑":{readings:["„ÅÜ„Åø","„Åã„ÅÑ"], meaning:"mar"},
  "Êº¢":{readings:["„Åã„Çì"], meaning:"chin√™s (Êº¢)"},
  "Áâõ":{readings:["„ÅÜ„Åó","„Åé„ÇÖ„ÅÜ"], meaning:"boi / vaca"},
  "Áâ©":{readings:["„ÇÇ„ÅÆ","„Å∂„Å§"], meaning:"coisa / objeto"},
  "Áâπ":{readings:["„Å®„Åè"], meaning:"especial"},
  "Áä¨":{readings:["„ÅÑ„Å¨","„Åë„Çì"], meaning:"cachorro"},
  "ÁêÜ":{readings:["„Çä"], meaning:"raz√£o / l√≥gica"},
  "Áî®":{readings:["„Çà„ÅÜ","„ÇÇ„Å°"], meaning:"uso"},
  "Áî∞":{readings:["„Åü","„Åß„Çì"], meaning:"arrozal"},
  "Áî∫":{readings:["„Åæ„Å°","„Å°„Çá„ÅÜ"], meaning:"cidade / bairro"},
  "Áîª":{readings:["„Åå","„Åà"], meaning:"desenho / quadro"},
  "Áïå":{readings:["„Åã„ÅÑ"], meaning:"mundo / limite"},
  "ÁóÖ":{readings:["„ÇÑ„Åæ„ÅÑ","„Å≥„Çá„ÅÜ"], meaning:"doen√ßa"},
  "Áô∫":{readings:["„ÅØ„Å§","„ÅØ„Å£"], meaning:"partida / emitir"},
  "ÁöÑ":{readings:["„Å¶„Åç"], meaning:"alvo / sufixo -al"},
  "ÁõÆ":{readings:["„ÇÅ","„ÇÇ„Åè"], meaning:"olho"},
  "Áúü":{readings:["„Åæ","„Åó„Çì"], meaning:"verdadeiro"},
  "ÁùÄ":{readings:["„Åç","„Å°„ÇÉ„Åè"], meaning:"vestir / chegar"},
  "Áü•":{readings:["„Åó","„Åó„Çã"], meaning:"saber / conhecer"},
  "Á†î":{readings:["„Åë„Çì","„Å®"], meaning:"pesquisa / polir"},
  "Á§æ":{readings:["„Åó„ÇÉ"], meaning:"empresa / sociedade"},
  "ÁßÅ":{readings:["„Çè„Åü„Åó","„Åó"], meaning:"eu / privado"},
  "Áßã":{readings:["„ÅÇ„Åç"], meaning:"outono"},
  "Á©∂":{readings:["„Åç„ÇÖ„ÅÜ"], meaning:"investigar"},
  "Á©∫":{readings:["„Åù„Çâ","„Åè„ÅÜ"], meaning:"c√©u / vazio"},
  "Á´ã":{readings:["„Åü","„Çä„Å§"], meaning:"ficar em p√©"},
  "Á≠î":{readings:["„Åì„Åü","„Å®„ÅÜ"], meaning:"responder / resposta"},
  "Á¥ô":{readings:["„Åã„Åø","„Åó"], meaning:"papel"},
  "ÁµÇ":{readings:["„Åä","„Åó„ÇÖ„ÅÜ"], meaning:"terminar"},
  "Áøí":{readings:["„Å™„Çâ","„Åó„ÇÖ„ÅÜ"], meaning:"aprender / praticar"},
  "ËÄÉ":{readings:["„Åã„Çì„Åå","„Åì„ÅÜ"], meaning:"pensar"},
  "ËÄÖ":{readings:["„ÇÇ„ÅÆ","„Åó„ÇÉ"], meaning:"pessoa"},
  "ËÇâ":{readings:["„Å´„Åè"], meaning:"carne"},
  "Ëá™":{readings:["„Åò"], meaning:"si mesmo"},
  "Ëâ≤":{readings:["„ÅÑ„Çç","„Åó„Çá„Åè"], meaning:"cor"},
  "Ëä±":{readings:["„ÅØ„Å™","„Åã"], meaning:"flor"},
  "Ëã±":{readings:["„Åà„ÅÑ"], meaning:"ingl√™s"},
  "Ëå∂":{readings:["„Å°„ÇÉ","„Åï"], meaning:"ch√°"},
  "Ë¶™":{readings:["„Åä„ÇÑ","„Åó„Çì"], meaning:"pais / √≠ntimo"},
  "Ë®Ä":{readings:["„ÅÑ","„Åí„Çì"], meaning:"dizer / palavra"},
  "Ë®à":{readings:["„ÅØ„Åã","„Åë„ÅÑ"], meaning:"medir / plano"},
  "Ë©¶":{readings:["„Åü„ÇÅ","„Åó"], meaning:"testar"},
  "Ë≤∑":{readings:["„Åã","„Å∞„ÅÑ"], meaning:"comprar"},
  "Ë≤∏":{readings:["„Åã","„Åü„ÅÑ"], meaning:"emprestar (dar)"},
  "Ë≥™":{readings:["„Åó„Å§"], meaning:"qualidade / pergunta"},
  "Ëµ§":{readings:["„ÅÇ„Åã","„Åõ„Åç"], meaning:"vermelho"},
  "Ëµ∞":{readings:["„ÅØ„Åó","„Åù„ÅÜ"], meaning:"correr"},
  "Ëµ∑":{readings:["„Åä","„Åç"], meaning:"levantar / acontecer"},
  "Ë∂≥":{readings:["„ÅÇ„Åó","„Åù„Åè"], meaning:"p√©"},
  "Ëª¢":{readings:["„Åì„Çç","„Å¶„Çì"], meaning:"girar / cair"},
  "Ëøë":{readings:["„Å°„Åã","„Åç„Çì"], meaning:"perto"},
  "ÈÄÅ":{readings:["„Åä„Åè","„Åù„ÅÜ"], meaning:"enviar"},
  "ÈÄö":{readings:["„Å®„Åä","„Å§„ÅÜ"], meaning:"passar / comunicar"},
  "ÈÄ±":{readings:["„Åó„ÇÖ„ÅÜ"], meaning:"semana"},
  "ÈÅã":{readings:["„ÅØ„Åì","„ÅÜ„Çì"], meaning:"transportar / sorte"},
  "ÈÅì":{readings:["„Åø„Å°","„Å©„ÅÜ"], meaning:"caminho"},
  "Èáç":{readings:["„Åä„ÇÇ","„Åò„ÇÖ„ÅÜ"], meaning:"pesado"},
  "Èáé":{readings:["„ÅÆ","„ÇÑ"], meaning:"campo / interior"},
  "ÈäÄ":{readings:["„Åé„Çì"], meaning:"prata"},
  "Èñã":{readings:["„ÅÇ","„Åã„ÅÑ"], meaning:"abrir"},
  "Èô¢":{readings:["„ÅÑ„Çì"], meaning:"institui√ß√£o"},
  "ÈõÜ":{readings:["„ÅÇ„Å§","„Åó„ÇÖ„ÅÜ"], meaning:"juntar / reunir"},
  "Èùí":{readings:["„ÅÇ„Åä","„Åõ„ÅÑ"], meaning:"azul / verde"},
  "Èü≥":{readings:["„Åä„Å®","„Åä„Çì"], meaning:"som"},
  "È°å":{readings:["„Å†„ÅÑ"], meaning:"t√≠tulo / tema"},
  "È¢®":{readings:["„Åã„Åú","„Åµ„ÅÜ"], meaning:"vento"},
  "È£Ø":{readings:["„ÇÅ„Åó","„ÅØ„Çì"], meaning:"refei√ß√£o / arroz"},
  "È£≤":{readings:["„ÅÆ","„ÅÑ„Çì"], meaning:"beber"},
  "È§®":{readings:["„Åã„Çì"], meaning:"pr√©dio / estabelecimento"},
  "ÈßÖ":{readings:["„Åà„Åç"], meaning:"esta√ß√£o"},
  "È®ì":{readings:["„Åë„Çì"], meaning:"experi√™ncia / teste"},
  "È≠ö":{readings:["„Åï„Åã„Å™","„Åé„Çá"], meaning:"peixe"},
  "È≥•":{readings:["„Å®„Çä","„Å°„Çá„ÅÜ"], meaning:"p√°ssaro"},
  "Èªí":{readings:["„Åè„Çç","„Åì„Åè"], meaning:"preto"}
};

function isInfoComplete(k){
  const i = KANJI_INFO[k];
  return !!(i && i.meaning && Array.isArray(i.readings) && i.readings.length && i.readings[0] !== "‚Äî");
}

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);

function flash(type){
  const f = $("flash");
  f.className = "flash " + type;
  void f.offsetWidth;
  f.classList.add("on");
  setTimeout(()=>f.classList.remove("on"), 560);
}
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function levelOf(k){
  if(N5_SET.has(k)) return "N5";
  if(N4_SET.has(k)) return "N4";
  return "N4";
}
function allKanjisUnique(){
  const set = new Set([...N5_LIST, ...N4_LIST]);
  return Array.from(set);
}
function poolByLevel(level){
  const all = allKanjisUnique().filter(isInfoComplete);
  if(level === "N5") return all.filter(k=>N5_SET.has(k));
  if(level === "N4") return all.filter(k=>N4_SET.has(k));
  return all;
}
function toHiragana(s){
  return (s||"").replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function normalizeSearch(s){
  return toHiragana((s||"").trim().toLowerCase());
}
function isKana(s){
  return /^[\u3040-\u309F\u30A0-\u30FF„Éº]+$/.test(s);
}
function isKanjiLike(s){
  return /[\u4E00-\u9FFF]/.test(s);
}
function safeInfo(k){
  const info = KANJI_INFO[k] || {readings:["‚Äî"], meaning:"‚Äî"};
  const r = (info.readings||[]).map(toHiragana).filter(Boolean);
  return { readings: r.length ? r : ["‚Äî"], meaning: info.meaning || "‚Äî" };
}

/* =========================
   VOCAB EXAMPLES (Jisho ‚Üí PT-BR)
   - Busca no Jisho (API)
   - Traduz EN ‚Üí PT-BR via MyMemory (gr√°tis)
========================= */
const exampleCache = new Map();       // kanji -> html pronto
const translateCache = new Map();     // enText -> ptText
let examplesReqSeq = 0;               // evita race condition

function escapeHTML(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function fetchJSON(url){
  // tentativa direta
  try{
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  }catch{
    // fallback CORS proxy
    const proxied = "https://cors.isomorphic-git.org/" + url;
    const r2 = await fetch(proxied, { cache:"no-store" });
    if(!r2.ok) throw new Error("HTTP " + r2.status);
    return await r2.json();
  }
}

async function translateENtoPT(enText){
  const key = (enText || "").trim();
  if(!key) return "‚Äî";
  if(translateCache.has(key)) return translateCache.get(key);

  // MyMemory: EN -> PT
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(key)}&langpair=en|pt`;
  try{
    const json = await fetchJSON(url);
    const pt = json?.responseData?.translatedText ? String(json.responseData.translatedText) : "";
    const out = pt && pt.toLowerCase() !== key.toLowerCase() ? pt : key;
    translateCache.set(key, out);
    return out;
  }catch{
    translateCache.set(key, key); // fallback
    return key;
  }
}

function pickThreeVocabFromJisho(data, kanji){
  const out = [];
  const seen = new Set();
  const rows = Array.isArray(data?.data) ? data.data : [];

  for(const row of rows){
    const ja = Array.isArray(row.japanese) ? row.japanese : [];
    const senses = Array.isArray(row.senses) ? row.senses : [];

    let chosen = null;
    for(const form of ja){
      const w = form.word || "";
      if(w && w.includes(kanji)){ chosen = form; break; }
    }
    if(!chosen || !chosen.word) continue;

    const word = chosen.word;
    if(seen.has(word)) continue;
    seen.add(word);

    const reading = chosen.reading || (ja[0]?.reading || "‚Äî");

    let meaningEN = "‚Äî";
    if(senses[0]?.english_definitions?.length){
      meaningEN = senses[0].english_definitions.slice(0, 3).join("; ");
    }

    out.push({ word, reading, meaningEN });
    if(out.length === 3) break;
  }
  return out;
}

async function renderQuizExamples(kanji){
  const el = $("quizExamples");
  if(!el) return;

  if(exampleCache.has(kanji)){
    el.innerHTML = exampleCache.get(kanji);
    return;
  }

  const mySeq = ++examplesReqSeq;
  el.textContent = "Carregando exemplos do Jisho‚Ä¶";

  const url = `https://jisho.org/api/v1/search/words?keyword=${encodeURIComponent(kanji)}`;

  try{
    const json = await fetchJSON(url);
    if(mySeq !== examplesReqSeq) return;

    const vocab = pickThreeVocabFromJisho(json, kanji);

    if(!vocab.length){
      const html = "‚Äî (sem exemplos suficientes no Jisho para este kanji)";
      exampleCache.set(kanji, html);
      el.innerHTML = html;
      return;
    }

    // traduz 3 significados (EN ‚Üí PT-BR)
    const ptMeanings = await Promise.all(
      vocab.map(v => translateENtoPT(v.meaningEN))
    );
    if(mySeq !== examplesReqSeq) return;

    const html = vocab.map((v, idx)=>{
      const pt = ptMeanings[idx] || v.meaningEN || "‚Äî";
      return `${idx+1}) <b>${escapeHTML(v.word)}</b>„Äê${escapeHTML(v.reading)}„Äë ‚Äî <span style="opacity:.92">PT:</span> ${escapeHTML(pt)}`;
    }).join("<br>");

    exampleCache.set(kanji, html);
    el.innerHTML = html;
  }catch{
    if(mySeq !== examplesReqSeq) return;
    el.innerHTML = `Falha ao buscar/traduzir (internet/CORS).`;
  }
}

/* =========================
   TABS
========================= */
const sections = { kanji:$("kanji"), quiz:$("quiz") };
const tabs = { kanji:$("tab-kanji"), quiz:$("tab-quiz") };
function openTab(id){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  Object.values(tabs).forEach(t=>t.classList.remove("active"));
  sections[id].classList.add("active");
  tabs[id].classList.add("active");
  if(id==="kanji") renderKanjiGrid();
}
tabs.kanji.addEventListener("click", ()=>openTab("kanji"));
tabs.quiz.addEventListener("click", ()=>openTab("quiz"));

/* =========================
   STROKE ORDER (KanjiVG)
========================= */
const svgCache = new Map();
const strokeAnimState = new WeakMap();

function codepointHex5(ch){
  return ch.codePointAt(0).toString(16).padStart(5,"0");
}
function clearSVGAnimation(svg){
  const st = strokeAnimState.get(svg);
  if(st?.length) st.forEach(t=>clearTimeout(t));
  strokeAnimState.set(svg, []);
}
function pickStrokePaths(svg){
  const all = Array.from(svg.querySelectorAll("path"));
  const strokes = all.filter(p=>{
    const id = (p.getAttribute("id") || "");
    return /-s\d+/.test(id);
  });
  return strokes.length ? strokes : all;
}
function preparePaths(paths){
  for(const p of paths){
    p.style.fill = "none";
    p.style.stroke = "var(--accent2)";
    p.style.strokeWidth = "3.4";
    p.style.strokeLinecap = "round";
    p.style.strokeLinejoin = "round";
    p.style.opacity = "1";
    p.style.transition = "none";
  }
}
function animateStrokeOrder(svg, speed=1){
  if(!svg) return;
  clearSVGAnimation(svg);

  const paths = pickStrokePaths(svg);
  if(!paths.length) return;

  preparePaths(paths);

  const lengths = paths.map(p=>{
    let len = 160;
    try{ len = p.getTotalLength(); }catch{}
    p.style.strokeDasharray = String(len);
    p.style.strokeDashoffset = String(len);
    return len;
  });

  const timeouts = [];
  let cursor = 0;

  for(let i=0;i<paths.length;i++){
    const p = paths[i];
    const len = lengths[i];
    const dur = Math.max(220, Math.min(900, len*2.1)) * speed;

    const t = setTimeout(()=>{
      p.style.transition = `stroke-dashoffset ${dur}ms linear`;
      p.style.strokeDashoffset = "0";
    }, cursor);

    timeouts.push(t);
    cursor += dur + 85*speed;
  }
  strokeAnimState.set(svg, timeouts);
}

async function loadKanjiSVGInto(kanji, targetEl){
  if(svgCache.has(kanji)){
    targetEl.innerHTML = svgCache.get(kanji);
    return targetEl.querySelector("svg");
  }
  const hex = codepointHex5(kanji);
  const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
  targetEl.innerHTML = `<div class="small">Carregando stroke order...</div>`;
  try{
    const res = await fetch(url, {cache:"force-cache"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const svgText = await res.text();
    const cleaned = svgText
      .replace(/width="[^"]*"/g,'')
      .replace(/height="[^"]*"/g,'')
      .replace(/<\?xml[^>]*\?>/g,'');
    svgCache.set(kanji, cleaned);
    targetEl.innerHTML = cleaned;
    return targetEl.querySelector("svg");
  }catch{
    targetEl.innerHTML = `<div class="small">Falha ao carregar. Ctrl+F5 e tente novamente.</div>`;
    return null;
  }
}

/* =========================
   KANJI TAB + SEARCH
========================= */
const kanjigrid = $("kanjigrid");
const levelFilter = $("levelFilter");
const kanjiCountHint = $("kanjiCountHint");
const kanjiSearch = $("kanjiSearch");
const clearSearch = $("clearSearch");

const kdBox = $("kanjiDetail");
const kdEmpty = $("kanjiDetailEmpty");
const kdKanji = $("kdKanji");
const kdReadings = $("kdReadings");
const kdMean = $("kdMean");
const kdBadges = $("kdBadges");
const kdStroke = $("kdStroke");
const kdSpeed = $("kdSpeed");

let selectedKanji = null;
let kdSvgEl = null;

function matchesSearch(kanji, info, query){
  if(!query) return true;

  const q = normalizeSearch(query);
  const infoR = (info.readings||[]).map(normalizeSearch);
  const mean = normalizeSearch(info.meaning || "");

  if(isKanjiLike(query)) return kanji.includes(query.trim());
  if(isKana(query)) return infoR.some(r => r.includes(q));
  return mean.includes(q);
}

function renderKanjiGrid(){
  const level = levelFilter.value;
  const base = poolByLevel(level);

  const q = (kanjiSearch.value||"").trim();
  const out = [];
  for(const k of base){
    const info = safeInfo(k);
    if(matchesSearch(k, info, q)) out.push(k);
  }

  kanjiCountHint.textContent = `Mostrando: ${out.length} / ${base.length} (Total n√≠vel) ‚Ä¢ Total geral: ${poolByLevel("ALL").length}`;

  kanjigrid.innerHTML = "";
  const frag = document.createDocumentFragment();

  for(const k of out){
    const lvl = levelOf(k);
    const div = document.createElement("div");
    div.className = "kanjiitem";
    div.innerHTML = `
      <div class="k">${k}</div>
      <div class="lvl"><b>${lvl}</b></div>
    `;
    div.addEventListener("click", ()=>showKanjiDetail(k, true));
    frag.appendChild(div);
  }
  kanjigrid.appendChild(frag);
}

levelFilter.addEventListener("change", ()=>{
  selectedKanji = null;
  kdSvgEl = null;
  kdBox.style.display = "none";
  kdEmpty.style.display = "block";
  renderKanjiGrid();
});
kanjiSearch.addEventListener("input", ()=>{
  if(window.__kSearchT) clearTimeout(window.__kSearchT);
  window.__kSearchT = setTimeout(()=>renderKanjiGrid(), 80);
});
clearSearch.addEventListener("click", ()=>{
  kanjiSearch.value = "";
  renderKanjiGrid();
});

async function showKanjiDetail(k, autoScroll){
  selectedKanji = k;

  kdEmpty.style.display="none";
  kdBox.style.display="block";

  const info = safeInfo(k);
  const lvl = levelOf(k);

  kdKanji.textContent = k;
  kdReadings.textContent = `Leituras: ${info.readings.join(" / ")}`;
  kdMean.textContent = `Significado: ${info.meaning}`;

  kdBadges.innerHTML = `
    <span class="badge ${lvl.toLowerCase()}">${lvl}</span>
    <span class="badge tag">kanji</span>
  `;

  if(autoScroll){
    $("detailPanel").scrollIntoView({behavior:"smooth", block:"start"});
    setTimeout(()=> $("kdStrokeBox").scrollIntoView({behavior:"smooth", block:"start"}), 250);
  }

  kdSvgEl = await loadKanjiSVGInto(k, kdStroke);
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
}

$("kdReplay").addEventListener("click", ()=>{
  if(!selectedKanji) return;
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
});
kdSpeed.addEventListener("change", ()=>{
  if(!selectedKanji) return;
  animateStrokeOrder(kdSvgEl, Number(kdSpeed.value));
});
$("kdTrain").addEventListener("click", ()=>{
  if(!selectedKanji) return;
  openTab("quiz");
  setQuestion(selectedKanji, true);
});

/* =========================
   QUIZ STATS
========================= */
const LS_KEY = "vampire_kanji_quiz_ptbr_v3";

function defaultStats(){
  return {
    bestStreak:0, bestAccuracy:0, bestScore:0,
    totalCorrect:0, totalWrong:0,
    perKanji:{}, recent:[],
    reviewQueue:[],      // kanjis pra revisar (persistente)
    reviewPass:{}        // k -> passes consecutivos no modo revis√£o
  };
}
function loadStats(){
  try{ const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : defaultStats(); }
  catch{ return defaultStats(); }
}
function saveStats(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(stats)); }catch{} }
let stats = loadStats();

function ensurePerKanji(k){ if(!stats.perKanji[k]) stats.perKanji[k] = {c:0,w:0}; }
function pushRecent(ok){
  stats.recent.push(ok ? 1 : 0);
  if(stats.recent.length > 12) stats.recent.shift();
}
function moodScore(){
  if(!stats.recent.length) return 0.5;
  const sum = stats.recent.reduce((a,b)=>a+b,0);
  return sum / stats.recent.length;
}
function applyMood(){
  const s = moodScore();
  $("quizMoodText").textContent = `Mood: ${Math.round(s*100)}%`;
}

/* =========================
   REVIEW MODE (fila de erros)
   ‚úÖ op√ß√£o s√≥ aparece se houver erros
   ‚úÖ ao entrar no modo revis√£o: "resetar" sess√£o + ordem da revis√£o
========================= */
function reviewCount(){ return Array.isArray(stats.reviewQueue) ? stats.reviewQueue.length : 0; }
function updateReviewUI(){
  const el = $("quizReviewText");
  if(el) el.textContent = `Revis√£o: ${reviewCount()}`;
  refreshReviewAvailability();
}
function refreshReviewAvailability(){
  const has = reviewCount() > 0;
  const wrap = $("reviewToggleWrap");
  const chk  = $("quizReviewOnly");
  if(wrap) wrap.style.display = has ? "inline-flex" : "none";
  if(!has && chk){
    chk.checked = false; // ‚úÖ se n√£o tem erro, n√£o deixa essa op√ß√£o ligada
  }
}

function addToReview(k){
  if(!stats.reviewQueue) stats.reviewQueue = [];
  if(!stats.reviewPass) stats.reviewPass = {};
  if(!stats.reviewQueue.includes(k)){
    stats.reviewQueue.push(k);
  }
  stats.reviewPass[k] = 0;
  updateReviewUI();
  saveStats();
  rebuildReviewOrder(true);
}

function passReview(k){
  if(!stats.reviewPass) stats.reviewPass = {};
  stats.reviewPass[k] = (stats.reviewPass[k] || 0) + 1;

  // regra: remove da fila depois de 2 acertos seguidos em modo revis√£o
  if(stats.reviewPass[k] >= 2){
    stats.reviewQueue = (stats.reviewQueue || []).filter(x => x !== k);
    delete stats.reviewPass[k];
    rebuildReviewOrder(true);
  }
  updateReviewUI();
  saveStats();
}

/* =========================
   QUIZ ENGINE
========================= */
const quizSmart = $("quizSmart");
const quizAuto = $("quizAuto");
const quizReviewOnly = $("quizReviewOnly");

const quizLevel = $("quizLevel");
const quizKanji = $("quizKanji");
const quizScoreEl = $("quizScore");
const quizTimerText = $("quizTimerText");
const timerBar = $("timerBar");
const quizTime = $("quizTime");

const readingChoices = $("readingChoices");
const meaningChoices = $("meaningChoices");

const quizFeedback = $("quizFeedback");
const quizFeedbackTitle = $("quizFeedbackTitle");
const quizFeedbackDetail = $("quizFeedbackDetail");
const quizStroke = $("quizStroke");
const quizSpeed = $("quizSpeed");

const bestStatsEl = $("bestStats");
const worstKanjisEl = $("worstKanjis");

let quizSvgEl = null;

$("goKanji").addEventListener("click", ()=> openTab("kanji"));
$("resetHistory").addEventListener("click", ()=>{
  stats = defaultStats();
  saveStats();
  rebuildReviewOrder(true);
  updateRightPanel();
  applyMood();
  updateReviewUI();
  flash("bad");
});

const quizState = {
  current: "‰∏Ä",
  running: false,
  timerId: null,
  timeLeftMs: 12000,
  timeTotalMs: 12000,

  sessionCorrect: 0,
  sessionWrong: 0,
  sessionStreak: 0,

  answeredReading: false,
  answeredMeaning: false,
  okReading: false,
  okMeaning: false,

  lockedAfterResult: false,
  lastPick: null,

  // ‚úÖ revis√£o: ordem ‚Äúreset√°vel‚Äù
  reviewOrder: [],
  reviewIdx: 0
};

function updateScoreUI(){
  quizScoreEl.textContent =
    `Acertos: ${quizState.sessionCorrect} ¬∑ Erros: ${quizState.sessionWrong} ¬∑ Streak: ${quizState.sessionStreak}`;
}

function updateRightPanel(){
  const totalGlobal = stats.totalCorrect + stats.totalWrong;
  const accGlobal = totalGlobal ? (stats.totalCorrect / totalGlobal) : 0;

  bestStatsEl.innerHTML = `
    ‚Ä¢ Best streak: <b>${stats.bestStreak}</b><br>
    ‚Ä¢ Best accuracy: <b>${Math.round(stats.bestAccuracy*100)}%</b><br>
    ‚Ä¢ Best score (C‚àíE): <b>${stats.bestScore}</b><br>
    ‚Ä¢ Global accuracy: <b>${Math.round(accGlobal*100)}%</b>
      (C:${stats.totalCorrect} / E:${stats.totalWrong})
  `;

  const arr = Object.entries(stats.perKanji).map(([k,v])=>{
    const total = v.c + v.w;
    const err = total ? (v.w / total) : 0;
    return {k, c:v.c, w:v.w, total, err};
  }).filter(x=>x.total>0);

  arr.sort((a,b)=> (b.w - a.w) || (b.err - a.err));
  const top = arr.slice(0,10);

  worstKanjisEl.innerHTML = top.length
    ? top.map(x=>{
        const pct = Math.round(x.err*100);
        return `‚Ä¢ <b>${x.k}</b> ‚Äî erros: ${x.w} / ${x.total} (${pct}%)`;
      }).join("<br>")
    : "‚Äî";
}

function updateBests(){
  stats.bestStreak = Math.max(stats.bestStreak, quizState.sessionStreak);
  const totalSession = quizState.sessionCorrect + quizState.sessionWrong;
  const accSession = totalSession ? (quizState.sessionCorrect / totalSession) : 0;
  const scoreSession = quizState.sessionCorrect - quizState.sessionWrong;
  stats.bestAccuracy = Math.max(stats.bestAccuracy, accSession);
  stats.bestScore = Math.max(stats.bestScore, scoreSession);
}

function readingText(k){ return safeInfo(k).readings.join(" / "); }
function meaningText(k){ return safeInfo(k).meaning; }

function buildChoices(kind, correctKanji, pool){
  const poolOthers = pool.filter(k => k !== correctKanji);

  const correctText =
    (kind === "reading") ? readingText(correctKanji) : meaningText(correctKanji);

  const picks = [{ text: correctText, correct: true }];

  const used = new Set([correctText]);
  const shuffled = shuffle(poolOthers);

  for(const k of shuffled){
    const t = (kind === "reading") ? readingText(k) : meaningText(k);
    if(!t || used.has(t)) continue;
    used.add(t);
    picks.push({ text: t, correct: false });
    if(picks.length === 4) break;
  }

  while(picks.length < 4){
    const k = poolOthers[Math.floor(Math.random() * poolOthers.length)];
    const t = (kind === "reading") ? readingText(k) : meaningText(k);
    if(!t || used.has(t)) continue;
    used.add(t);
    picks.push({ text: t, correct: false });
  }

  return shuffle(picks);
}

function resetQuestionState(){
  quizState.answeredReading = false;
  quizState.answeredMeaning = false;
  quizState.okReading = false;
  quizState.okMeaning = false;
  quizState.lockedAfterResult = false;
  quizFeedback.style.display = "none";
}

function resetSession(){
  quizState.sessionCorrect = 0;
  quizState.sessionWrong = 0;
  quizState.sessionStreak = 0;
  updateScoreUI();
}

function disableAllChoices(){
  document.querySelectorAll(".choiceBtn").forEach(b=> b.disabled = true);
}

function renderChoiceButtons(targetEl, options, onPick){
  targetEl.innerHTML = "";
  for(const opt of options){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "choiceBtn";
    b.textContent = opt.text;

    b.addEventListener("click", ()=>{
      if(quizState.lockedAfterResult) return;

      const btns = Array.from(targetEl.querySelectorAll(".choiceBtn"));
      btns.forEach(btn=> btn.disabled = true);

      btns.forEach((btn, idx)=>{ if(options[idx].correct) btn.classList.add("correct"); });

      if(opt.correct) b.classList.add("correct");
      else b.classList.add("wrong");

      onPick(opt.correct);
    });

    targetEl.appendChild(b);
  }
}

/* peso por erro (smart) */
function weightedPick(pool){
  let total = 0;
  const weights = pool.map(k=>{
    ensurePerKanji(k);
    const {c,w} = stats.perKanji[k];
    const unseen = (c+w===0) ? 1.0 : 0;
    const weight = Math.max(0.2, 1 + w*2.6 - c*0.30 + unseen);
    total += weight;
    return weight;
  });

  let r = Math.random() * total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function getBasePoolByUILevel(){
  const lvl = quizLevel.value;
  const pool = poolByLevel(lvl);
  return pool.length < 6 ? poolByLevel("ALL") : pool;
}

function getReviewPoolFiltered(){
  const base = getBasePoolByUILevel();
  const setBase = new Set(base);
  const q = Array.isArray(stats.reviewQueue) ? stats.reviewQueue : [];
  const filtered = q.filter(k => setBase.has(k) && isInfoComplete(k));
  return filtered;
}

function getQuizPool(){
  // se revisar erros ON -> s√≥ a fila de revis√£o
  if(quizReviewOnly && quizReviewOnly.checked){
    const rpool = getReviewPoolFiltered();
    // ‚úÖ se n√£o h√° erros, desliga e segue normal
    if(rpool.length < 1){
      quizReviewOnly.checked = false;
      refreshReviewAvailability();
      return getBasePoolByUILevel();
    }
    return rpool;
  }
  return getBasePoolByUILevel();
}

function rebuildReviewOrder(force){
  const pool = getReviewPoolFiltered();
  const keyNow = pool.join("");
  const keyPrev = (quizState.reviewOrder || []).join("");
  if(force || keyNow !== keyPrev){
    quizState.reviewOrder = shuffle(pool);
    quizState.reviewIdx = 0;
  }
}

function pickFromReview(){
  rebuildReviewOrder(false);
  if(!quizState.reviewOrder.length) return null;
  const k = quizState.reviewOrder[quizState.reviewIdx % quizState.reviewOrder.length];
  quizState.reviewIdx++;
  return k;
}

function pickKanji(pool){
  if(quizReviewOnly && quizReviewOnly.checked){
    return pickFromReview() || pool[Math.floor(Math.random()*pool.length)];
  }

  let k = quizSmart.checked ? weightedPick(pool) : pool[Math.floor(Math.random()*pool.length)];
  if(pool.length > 1 && k === quizState.lastPick){
    k = pool[Math.floor(Math.random()*pool.length)];
  }
  quizState.lastPick = k;
  return k;
}

async function showFeedback(okAll, reason){
  const k = quizState.current;
  const info = safeInfo(k);

  quizFeedback.style.display = "block";
  quizFeedbackTitle.innerHTML = okAll
    ? `‚úÖ <b>Acertou</b>`
    : (reason === "timeout" ? `‚è±Ô∏è <b>Tempo esgotado</b>` : `‚ùå <b>Errou</b>`);

  quizFeedbackDetail.innerHTML = `
    Kanji: <b>${k}</b> ¬∑ <b>${levelOf(k)}</b><br>
    Leituras: <b>${info.readings.join(" / ")}</b><br>
    Significado: <b>${info.meaning}</b>
  `;

  // ‚úÖ 3 palavras do Jisho + PT-BR
  renderQuizExamples(k);

  quizSvgEl = await loadKanjiSVGInto(k, quizStroke);
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));
}

function commitResult(okAll, reason){
  const k = quizState.current;
  ensurePerKanji(k);

  if(okAll){
    quizState.sessionCorrect += 1;
    quizState.sessionStreak += 1;
    stats.totalCorrect += 1;
    stats.perKanji[k].c += 1;
    pushRecent(true);
    flash("good");

    // ‚úÖ se est√° em modo revis√£o, 2 acertos seguidos removem da fila
    if(quizReviewOnly && quizReviewOnly.checked) passReview(k);
  }else{
    quizState.sessionWrong += 1;
    quizState.sessionStreak = 0;
    stats.totalWrong += 1;
    stats.perKanji[k].w += 1;
    pushRecent(false);
    flash("bad");

    // ‚úÖ qualquer erro/timeout entra na fila de revis√£o (e a op√ß√£o aparece)
    addToReview(k);
  }

  updateScoreUI();
  updateBests();
  applyMood();
  updateRightPanel();
  updateReviewUI();
  saveStats();

  stopTimer();
  disableAllChoices();

  quizState.lockedAfterResult = true;
  showFeedback(okAll, reason);
}

function evaluateIfComplete(){
  if(!(quizState.answeredReading && quizState.answeredMeaning)) return;
  const okAll = quizState.okReading && quizState.okMeaning;
  commitResult(okAll, "answered");
}

function setQuestion(kanji, keepTimerRunning){
  quizState.current = kanji;
  quizKanji.textContent = kanji;

  resetQuestionState();

  const pool = getQuizPool();

  const rOpts = buildChoices("reading", kanji, pool);
  const mOpts = buildChoices("meaning", kanji, pool);

  renderChoiceButtons(readingChoices, rOpts, (ok)=>{
    quizState.answeredReading = true;
    quizState.okReading = ok;
    evaluateIfComplete();
  });

  renderChoiceButtons(meaningChoices, mOpts, (ok)=>{
    quizState.answeredMeaning = true;
    quizState.okMeaning = ok;
    evaluateIfComplete();
  });

  if(quizState.running){
    startTimer(true);
  }else if(!keepTimerRunning){
    const seconds = Number(quizTime.value);
    quizState.timeTotalMs = seconds * 1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }else{
    if(quizAuto.checked) startTimer(true);
    else{
      const seconds = Number(quizTime.value);
      quizState.timeTotalMs = seconds * 1000;
      quizState.timeLeftMs = quizState.timeTotalMs;
      updateTimerUI();
    }
  }
}

function nextQuestion(){
  const pool = getQuizPool();
  const k = pickKanji(pool);
  setQuestion(k, true);
}

/* =========================
   TIMER
========================= */
function updateTimerUI(){
  const leftSec = Math.max(0, Math.ceil(quizState.timeLeftMs/1000));
  quizTimerText.textContent = `‚è±Ô∏è ${leftSec}s`;
  const pct = quizState.timeTotalMs ? (quizState.timeLeftMs/quizState.timeTotalMs) : 0;
  timerBar.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
}
function stopTimer(){
  if(quizState.timerId){
    clearInterval(quizState.timerId);
    quizState.timerId = null;
  }
  quizState.running = false;
}
function startTimer(reset){
  const seconds = Number(quizTime.value);
  quizState.timeTotalMs = seconds*1000;
  if(reset) quizState.timeLeftMs = quizState.timeTotalMs;

  stopTimer();
  quizState.running = true;

  quizState.timerId = setInterval(()=>{
    if(quizState.lockedAfterResult) return;
    quizState.timeLeftMs -= 200;
    updateTimerUI();
    if(quizState.timeLeftMs <= 0){
      stopTimer();
      if(!quizState.lockedAfterResult) commitResult(false, "timeout");
    }
  }, 200);

  updateTimerUI();
}

/* =========================
   CONTROLES QUIZ
========================= */
$("quizStart").addEventListener("click", ()=>{
  if(quizState.lockedAfterResult) return;
  startTimer(true);
});
$("quizPause").addEventListener("click", ()=>{
  if(quizState.lockedAfterResult) return;
  if(quizState.running) stopTimer();
  else startTimer(false);
});
$("quizNext").addEventListener("click", ()=>{
  nextQuestion();
  updateRightPanel();
  updateReviewUI();
  saveStats();
});
$("quizReset").addEventListener("click", ()=>{
  stopTimer();
  resetSession();
  updateRightPanel();
  updateReviewUI();
  saveStats();
  flash("bad");
  nextQuestion();
});

quizTime.addEventListener("change", ()=>{
  if(quizState.lockedAfterResult) return;
  if(quizState.running) startTimer(true);
  else{
    quizState.timeTotalMs = Number(quizTime.value)*1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
});
$("quizReplay").addEventListener("click", ()=>{
  if(!quizSvgEl) return;
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));
});
quizSpeed.addEventListener("change", ()=>{
  if(!quizSvgEl) return;
  animateStrokeOrder(quizSvgEl, Number(quizSpeed.value));
});
quizLevel.addEventListener("change", ()=>{
  rebuildReviewOrder(true);
  nextQuestion();
});

if(quizReviewOnly){
  quizReviewOnly.addEventListener("change", ()=>{
    // ‚úÖ ao entrar no modo revis√£o: resetar sess√£o + resetar ordem da revis√£o
    if(quizReviewOnly.checked){
      rebuildReviewOrder(true);
      resetSession();
      stopTimer();
      nextQuestion();
    }else{
      stopTimer();
      nextQuestion();
    }
    updateReviewUI();
  });
}

/* =========================
   INIT
========================= */
function init(){
  renderKanjiGrid();
  updateRightPanel();
  applyMood();
  updateScoreUI();
  rebuildReviewOrder(true);
  updateReviewUI();
  setQuestion("‰∏Ä", false);
}
init();

/* =========================
   PORTAL / ENTRADA
========================= */
(function(){
  const gate = document.getElementById("gate");
  const app  = document.getElementById("app");
  const btn  = document.getElementById("enterBtn");
  const petalsBox = document.getElementById("petals");

  if(!gate || !app || !btn || !petalsBox) return;

  function spawnPetals(n=28){
    petalsBox.innerHTML = "";
    for(let i=0;i<n;i++){
      const p = document.createElement("span");
      p.className = "petal";

      const x = Math.random()*100;
      const drift = (Math.random()*40 - 20);
      const dur = 11 + Math.random()*9;
      const delay = Math.random()*4;

      p.style.setProperty("--x", `${x}vw`);
      p.style.setProperty("--drift", `${drift}vw`);
      p.style.setProperty("--dur", `${dur}s`);
      p.style.setProperty("--delay", `${delay}s`);

      const scale = 0.75 + Math.random()*1.1;
      p.style.width  = `${16*scale}px`;
      p.style.height = `${12*scale}px`;

      petalsBox.appendChild(p);
    }
  }

  function chime(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(880, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.10);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.22);
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.24);
      setTimeout(()=>ctx.close?.(), 380);
    }catch{}
  }

  spawnPetals(28);

  function enter(){
    gate.classList.add("leaving");
    btn.disabled = true;

    chime();

    setTimeout(()=>{
      gate.style.display = "none";
      app.classList.remove("appHidden");
      window.scrollTo(0,0);
    }, 1700);
  }

  btn.addEventListener("click", enter);
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && gate.style.display !== "none") enter();
  });

  let t=null;
  window.addEventListener("resize", ()=>{
    clearTimeout(t);
    t=setTimeout(()=>spawnPetals(28), 200);
  });
})();
</script>

</div><!-- fecha #app -->
</body>
</html>
